<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tactics & Treats – Size Builder</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body{
      font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      font-weight:500;
      background:#111;
      color:#fff;
      margin:0;
      padding:18px;
    }
    header{
      display:flex;
      justify-content:center;
      background:linear-gradient(90deg,#7a0c0c,#000);
      padding:14px;
      border-radius:10px;
      box-shadow:0 0 12px rgba(255,0,0,0.4);
      margin-bottom:12px;
    }
    h1{ margin:0; color:#ff0000; font-weight:800; }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      gap:12px;
    }

    .card{
      background:#181818;
      padding:14px;
      border-radius:12px;
      box-shadow:0 0 12px rgba(255,0,0,0.2);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    input, textarea, select{
      background:#111;
      color:#fff;
      border:1px solid #ff0000;
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      font-weight:600;
      width:100%;
      box-sizing:border-box;
    }
    textarea{ min-height:90px; resize:vertical; }

    .btn{
      background:#ff0000;
      color:#fff;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .btn:hover{ background:darkred; }
    .btn.secondary{
      background:#222;
      border:1px solid #ff0000;
    }

    .hint{ font-size:12px; opacity:.85; line-height:1.35; margin-top:6px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 900px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .list{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .item{
      background:#111;
      border:1px solid #ff0000;
      border-radius:12px;
      padding:10px;
      cursor:pointer;
      box-shadow:0 0 10px rgba(255,0,0,0.12);
      user-select:none;
      touch-action:manipulation;
    }
    .item:hover{ box-shadow:0 0 14px rgba(255,0,0,0.25); }
    .item.active{
      background:#ff0000;
      border-color:#ff0000;
      box-shadow:0 0 14px rgba(255,0,0,0.45);
    }
    .item .title{ font-weight:900; }
    .item .sub{ font-size:12px; opacity:.9; margin-top:4px; }

    .ok{ color:#7CFF7C; font-weight:800; }
    .bad{ color:#ff7c7c; font-weight:800; }
  </style>
</head>

<body>
  <header><h1>Size Builder</h1></header>

  <div class="wrap">

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="hint">Collection:</div>
          <div class="mono" style="font-weight:900;">products_bracelets</div>
        </div>
        <div class="row">
          <button class="btn secondary" id="refreshBtn">Refresh</button>
        </div>
      </div>
      <div class="hint">
        Pick a product → type sizes like <span class="mono">5 6 7.5 8 9 10</span> → saves as
        <span class="mono">5", 6", 7.5", 8", ...</span> into <span class="mono">sizeOptions</span>.
      </div>
      <div class="hint" id="statusLine"></div>
    </div>

    <div class="card">
      <div style="font-weight:900; color:#ffb347;">Products</div>

      <!-- ✅ Dropdown fallback picker -->
      <div class="row" style="margin-top:10px;">
        <select id="productSelect"></select>
      </div>

      <!-- ✅ Clickable cards -->
      <div class="list" id="productList"></div>
    </div>

    <div class="card grid2">
      <div>
        <div style="font-weight:900; color:#ffb347;">Sizes (inches)</div>
        <input id="sizesInput" placeholder='Example: 5 6 7.5 8 9 10 11 12' />
        <div class="hint">
          Separators can be spaces / commas / new lines. Duplicates removed. Sorted smallest → biggest.
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" id="loadCurrentBtn">Load current sizeOptions</button>
          <button class="btn" id="saveBtn">Save sizeOptions</button>
        </div>

        <div class="hint" id="saveLine"></div>
      </div>

      <div>
        <div style="font-weight:900; color:#ffb347;">Preview (what gets saved)</div>
        <textarea id="previewBox" class="mono" readonly></textarea>
        <div class="hint" id="previewLine"></div>
      </div>
    </div>

  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection, doc, setDoc, addDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // SAME CONFIG YOU GAVE
  const firebaseConfig = {
    apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
    authDomain:"bracelets-and-color.firebaseapp.com",
    projectId:"bracelets-and-color",
    storageBucket:"bracelets-and-color.appspot.com",
    messagingSenderId:"382292570673",
    appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const PRODUCTS_COLLECTION = "products_bracelets";

  const productList = document.getElementById("productList");
  const productSelect = document.getElementById("productSelect");
  const sizesInput = document.getElementById("sizesInput");
  const previewBox = document.getElementById("previewBox");
  const previewLine = document.getElementById("previewLine");
  const statusLine = document.getElementById("statusLine");
  const saveLine = document.getElementById("saveLine");
  const refreshBtn = document.getElementById("refreshBtn");
  const saveBtn = document.getElementById("saveBtn");
  const loadCurrentBtn = document.getElementById("loadCurrentBtn");

  let unsub = null;
  let products = [];
  let selectedId = null;

  function uniq(arr){ return [...new Set(arr)]; }

  function parseSizesToOptions(text){
    const raw = String(text || "")
      .replace(/["']/g, "")
      .replace(/[^\d.\s,]+/g, " ")
      .split(/[\s,]+/g)
      .map(s => s.trim())
      .filter(Boolean);

    let nums = raw
      .map(v => Number(v))
      .filter(n => Number.isFinite(n) && n > 0);

    nums = uniq(nums.map(n => String(n))).map(s => Number(s));
    nums.sort((a,b)=>a-b);

    const formatted = nums.map(n => `${n}"`);
    return formatted.join(", ");
  }

  function setPreview(){
    const formatted = parseSizesToOptions(sizesInput.value);
    previewBox.value = formatted;

    if(!sizesInput.value.trim()){
      previewLine.innerHTML = `<span class="bad">Type some sizes to see preview.</span>`;
      return;
    }
    if(!formatted){
      previewLine.innerHTML = `<span class="bad">Couldn’t read sizes. Try: 5 6 7.5 8</span>`;
      return;
    }
    previewLine.innerHTML = `<span class="ok">Preview looks good.</span>`;
  }

  function pickProduct(id){
    selectedId = id;

    // highlight cards
    document.querySelectorAll(".item").forEach(el=>{
      el.classList.toggle("active", el.dataset.id === id);
    });

    // sync dropdown
    if(productSelect.value !== id) productSelect.value = id;

    const p = products.find(x=>x.id===id);
    if(p){
      saveLine.innerHTML =
        `Selected: <span class="mono">${p.id}</span><br>` +
        `Current sizeOptions: <span class="mono">${(p.sizeOptions ?? "(empty)")}</span>`;
    } else {
      saveLine.innerHTML = "";
    }
  }

  function renderProducts(){
    productList.innerHTML = "";
    productSelect.innerHTML = "";

    if(!products.length){
      productList.innerHTML = `<div class="hint bad">No products found in ${PRODUCTS_COLLECTION}.</div>`;
      const opt = new Option("No products found", "");
      productSelect.add(opt);
      return;
    }

    products.forEach(p=>{
      const title = p.type || p.name || p.id;

      // dropdown option
      const opt = new Option(title, p.id);
      productSelect.add(opt);

      // clickable card
      const div = document.createElement("div");
      div.className = "item";
      div.dataset.id = p.id;
      div.innerHTML = `
        <div class="title">${title}</div>
        <div class="sub mono">id: ${p.id}</div>
      `;

      // ✅ pointerup works better on mobile than click sometimes
      div.addEventListener("pointerup", ()=> pickProduct(p.id));

      productList.appendChild(div);
    });

    // auto pick first if none selected
    if(!selectedId) selectedId = products[0].id;

    productSelect.value = selectedId;
    pickProduct(selectedId);
  }

  function subscribeProducts(){
    if(unsub) unsub();

    statusLine.innerHTML = `Loading products...`;

    const colRef = collection(db, PRODUCTS_COLLECTION);

    unsub = onSnapshot(colRef, snap=>{
      products = snap.docs.map(d=>({ id:d.id, ...d.data() }));

      // sort by label
      products.sort((a,b)=>{
        const A = String(a.type || a.name || a.id).toLowerCase();
        const B = String(b.type || b.name || b.id).toLowerCase();
        return A.localeCompare(B);
      });

      statusLine.innerHTML = `<span class="ok">Loaded ${products.length} products.</span>`;
      renderProducts();
    }, err=>{
      console.error(err);
      statusLine.innerHTML = `<span class="bad">Error loading products: ${err.message}</span>`;
      productList.innerHTML = `<div class="hint bad">Check your Firestore rules / permissions.</div>`;
    });
  }

  async function loadCurrentIntoInput(){
    if(!selectedId){
      saveLine.innerHTML = `<span class="bad">Pick a product first.</span>`;
      return;
    }
    const p = products.find(x=>x.id===selectedId);
    const current = (p?.sizeOptions ?? "").toString();
    sizesInput.value = current.replace(/"/g,"").replace(/,\s*/g," ");
    setPreview();
    saveLine.innerHTML = `<span class="ok">Loaded current sizeOptions into the input.</span>`;
  }

  async function saveSizes(){
    if(!selectedId){
      saveLine.innerHTML = `<span class="bad">Pick a product first.</span>`;
      return;
    }

    const formatted = parseSizesToOptions(sizesInput.value);
    if(!formatted){
      saveLine.innerHTML = `<span class="bad">No valid sizes found. Example: 5 6 7.5 8</span>`;
      return;
    }

    const p = products.find(x=>x.id===selectedId);
    const before = p?.sizeOptions ?? null;

    await setDoc(doc(db, PRODUCTS_COLLECTION, selectedId), { sizeOptions: formatted }, { merge:true });

    await addDoc(collection(db, "auditLog"), {
      type: "sizeOptions_update",
      collection: PRODUCTS_COLLECTION,
      id: selectedId,
      field: "sizeOptions",
      from: before,
      to: formatted,
      at: new Date()
    });

    saveLine.innerHTML = `<span class="ok">Saved ✅</span>`;
  }

  sizesInput.addEventListener("input", setPreview);
  refreshBtn.addEventListener("click", subscribeProducts);
  saveBtn.addEventListener("click", saveSizes);
  loadCurrentBtn.addEventListener("click", loadCurrentIntoInput);

  // dropdown selects product too
  productSelect.addEventListener("change", () => {
    if(productSelect.value) pickProduct(productSelect.value);
  });

  setPreview();
  subscribeProducts();
</script>
</body>
</html>
