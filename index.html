<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bracelet Preorder</title>

<style>
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(to right, #7a0c0c, #000, #7a0c0c);
  color: white;
  margin: 0;
  padding: 20px;
}

nav {
  text-align: center;
  background: #111;
  padding: 10px 0;
  border-bottom: 2px solid #ff0000;
  box-shadow: 0 0 10px #ff0000;
}

nav a {
  color: white;
  margin: 0 15px;
  font-weight: bold;
  text-decoration: none;
}
nav a:hover {
  color: #ff0000;
  text-shadow: 0 0 6px #ff0000;
}

h1 {
  text-align: center;
  color: #ff0000;
  margin-bottom: 20px;
}

form {
  background: #111;
  border-radius: 16px;
  padding: 20px;
  margin: auto;
  max-width: 760px;
  box-shadow: 0 0 15px #ff0000;
}

label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
}

button {
  background: #ff0000;
  color: white;
  margin-top: 14px;
  font-weight: bold;
  cursor: pointer;
}
button:hover { background: darkred; }

button.secondary{
  background:#222;
  border:1px solid #ff0000;
}
button.secondary:hover{ background:#1a1a1a; }

#priceDisplay {
  margin-top: 12px;
  font-weight: bold;
  color: #ffb347;
  text-align: center;
  font-size: 16px;
}

#imagePreviewContainer {
  display: flex;
  justify-content: center;
  gap: 18px;
  margin-bottom: 18px;
}

#imagePreviewContainer img {
  border-radius: 8px;
  border: 2px solid #ff0000;
  object-fit: cover;
  opacity: 0;
  transition: opacity .4s;
  background:#000;
}

#mainBraceletImg {
  width: 200px;
  height: 200px;
  border-radius: 16px;
}

.sideImg {
  width: 80px;
  height: 80px;
}

#orderMsg {
  text-align: center;
  font-weight: bold;
  margin-top: 15px;
}

/* cart rows */
.cartWrap{
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.cartRow{
  border-top: 2px solid rgba(255,0,0,0.5);
  padding-top:12px;
}

.cartHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}
.cartHeader h3{
  margin:0;
  color:#ff0000;
  font-size:16px;
}

.grid4{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}
@media(min-width: 760px){
  .grid4{ grid-template-columns: 1.1fr .7fr 1fr 1fr; }
}

.rowPrice{
  margin-top:8px;
  text-align:right;
  color:#ffb347;
  font-weight:700;
}

.smallNote{
  font-size:12px;
  opacity:.85;
  margin-top:6px;
  text-align:center;
}
</style>
</head>

<body>

<nav>
  <a href="bracelets.html">Bracelets</a>
  <a href="spiritwear.html">Spirit Wear</a>
</nav>

<h1>Bracelet Preorder</h1>

<!-- IMAGE PREVIEW (shows last selected bracelet type) -->
<div id="imagePreviewContainer">
  <div style="display:flex; flex-direction:column; gap:10px;">
    <img id="sideImg1" class="sideImg" alt="">
    <img id="sideImg2" class="sideImg" alt="">
  </div>

  <img id="mainBraceletImg" alt="">

  <div style="display:flex; flex-direction:column; gap:10px;">
    <img id="sideImg3" class="sideImg" alt="">
    <img id="sideImg4" class="sideImg" alt="">
  </div>
</div>

<form id="braceletForm">
  <label>Name</label>
  <input id="braceletName" required>

  <label>Phone</label>
  <input id="braceletPhone" required>

  <div class="smallNote">
    Add up to 4 bracelets. Each one can be a different type + size + colors.
    Submit creates separate orders (admin easier).
  </div>

  <div class="cartWrap" id="cartWrap"></div>

  <button type="button" class="secondary" id="addBraceletBtn">+ Add Bracelet</button>

  <p id="priceDisplay">Total: $0.00</p>

  <button type="button" id="submitBtn">Submit Order</button>
</form>

<p id="orderMsg"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  getDoc,
  doc,
  addDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const cartWrap = document.getElementById("cartWrap");
const addBraceletBtn = document.getElementById("addBraceletBtn");

let products = [];            // [{id, ...data}]
let productsById = {};        // id -> product
let rowCount = 0;
const MAX_ROWS = 4;

/* IMAGE FADE */
function fade(img, src){
  img.style.opacity = 0;
  img.src = src;
  img.onerror = () => { img.style.opacity = 0.25; };
  setTimeout(()=>img.style.opacity = 1, 100);
}
function loadImages(type){
  const key = String(type || "").toLowerCase().trim().replace(/\s+/g,"-");
  fade(mainBraceletImg, `${key}-main.png`);
  fade(sideImg1, `${key}-side1.png`);
  fade(sideImg2, `${key}-side2.png`);
  fade(sideImg3, `${key}-side3.png`);
  fade(sideImg4, `${key}-side4.png`);
}

/* HELPERS */
function getPriceMap(p){
  if(!p || p.price == null) return {};
  if(typeof p.price === "object") return p.price;

  if(typeof p.price === "string"){
    try { return JSON.parse(p.price); } catch { return {}; }
  }
  return {};
}

function getSizesFromProduct(p){
  if(!p) return [];

  // main field
  if(Array.isArray(p.sizeOptions)) return p.sizeOptions;

  if(typeof p.sizeOptions === "string"){
    const arr = p.sizeOptions.split(",").map(s=>s.trim()).filter(Boolean);
    if(arr.length) return arr;
  }

  // backups
  if(Array.isArray(p.sizeOptions_array)) return p.sizeOptions_array;

  if(typeof p.sizeOptions_text === "string"){
    const arr = p.sizeOptions_text.split(",").map(s=>s.trim()).filter(Boolean);
    if(arr.length) return arr;
  }

  return [];
}

function unitPriceForSize(product, size){
  const priceMap = getPriceMap(product);
  const sizeRaw = String(size||"").trim();
  const sizeAlt = sizeRaw.replace(/"/g,"").trim();

  let unit = parseFloat(priceMap[sizeRaw]);
  if(Number.isNaN(unit)) unit = parseFloat(priceMap[sizeAlt]);

  if(Number.isNaN(unit)){
    const matchKey = Object.keys(priceMap).find(k => {
      const kk = String(k).trim();
      return kk === sizeRaw || kk === sizeAlt;
    });
    unit = matchKey ? parseFloat(priceMap[matchKey]) : NaN;
  }
  if(Number.isNaN(unit)) unit = 0;
  return unit;
}

function splitColors(colorOptions){
  return String(colorOptions || "")
    .split(",")
    .map(c => c.trim())
    .filter(Boolean);
}

/* TOTAL UPDATE */
function updateTotals(){
  let total = 0;

  cartWrap.querySelectorAll(".cartRow").forEach(row=>{
    const typeSel = row.querySelector(".typeSel");
    const sizeSel = row.querySelector(".sizeSel");
    const priceEl = row.querySelector(".rowPrice");

    const productId = typeSel.value;
    const p = productsById[productId];

    let unit = 0;
    if(p && sizeSel.value) unit = unitPriceForSize(p, sizeSel.value);

    total += unit;
    priceEl.textContent = `Bracelet price: $${unit.toFixed(2)}`;
  });

  priceDisplay.textContent = `Total: $${total.toFixed(2)}`;
}

/* FILL A ROW BASED ON PRODUCT */
function fillRowOptions(row, productId){
  const p = productsById[productId];

  const sizeSel = row.querySelector(".sizeSel");
  const c1Sel = row.querySelector(".c1Sel");
  const c2Sel = row.querySelector(".c2Sel");

  // sizes
  sizeSel.innerHTML = "";
  sizeSel.add(new Option("Select size", ""));
  if(p){
    const sizes = getSizesFromProduct(p);
    sizes.forEach(s => sizeSel.add(new Option(s, s)));
    if(sizes.length) sizeSel.value = sizes[0]; // auto pick first
  }

  // colors
  const colors = p ? splitColors(p.colorOptions) : [];
  c1Sel.innerHTML = "";
  c2Sel.innerHTML = "";
  c1Sel.add(new Option("Select color 1", ""));
  c2Sel.add(new Option("Select color 2", ""));
  colors.forEach(c=>{
    c1Sel.add(new Option(c,c));
    c2Sel.add(new Option(c,c));
  });

  if(colors.length){
    c1Sel.value = colors[0];
    c2Sel.value = colors[Math.min(1, colors.length-1)];
  }

  // preview updates to last selected type
  if(p) loadImages(p.type);

  updateTotals();
}

/* ADD ROW */
function addRow(){
  if(rowCount >= MAX_ROWS) return;

  rowCount++;
  const idx = rowCount;

  const row = document.createElement("div");
  row.className = "cartRow";
  row.dataset.index = idx;

  row.innerHTML = `
    <div class="cartHeader">
      <h3>Bracelet ${idx}</h3>
      <button type="button" class="secondary removeBtn" style="width:auto; padding:8px 10px;">Remove</button>
    </div>

    <div class="grid4">
      <div>
        <label>Type</label>
        <select class="typeSel"></select>
      </div>

      <div>
        <label>Size</label>
        <select class="sizeSel"></select>
      </div>

      <div>
        <label>Color 1</label>
        <select class="c1Sel"></select>
      </div>

      <div>
        <label>Color 2</label>
        <select class="c2Sel"></select>
      </div>
    </div>

    <div class="rowPrice">Bracelet price: $0.00</div>
  `;

  cartWrap.appendChild(row);

  // fill type list
  const typeSel = row.querySelector(".typeSel");
  typeSel.innerHTML = "";
  typeSel.add(new Option("Select bracelet", ""));
  products.forEach(p=>{
    typeSel.add(new Option(p.type ?? p.id, p.id));
  });

  // events
  typeSel.addEventListener("change", ()=>{
    fillRowOptions(row, typeSel.value);
  });
  row.querySelector(".sizeSel").addEventListener("change", updateTotals);

  row.querySelector(".removeBtn").addEventListener("click", ()=>{
    row.remove();

    // re-number titles
    const rows = [...cartWrap.querySelectorAll(".cartRow")];
    rowCount = rows.length;
    rows.forEach((r,i)=>{
      r.dataset.index = i+1;
      r.querySelector("h3").textContent = `Bracelet ${i+1}`;
    });

    updateTotals();
  });

  updateTotals();
}

/* LOAD PRODUCTS */
async function loadProducts(){
  const snap = await getDocs(collection(db,"products_bracelets"));

  products = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  products.sort((a,b)=>{
    const A = String(a.type ?? a.id).toLowerCase();
    const B = String(b.type ?? b.id).toLowerCase();
    return A.localeCompare(B);
  });

  productsById = {};
  products.forEach(p=> productsById[p.id] = p);
}

/* SUBMIT: separate orders */
submitBtn.onclick = async () => {
  const name = braceletName.value.trim();
  const phone = braceletPhone.value.trim();
  if(!name || !phone) return alert("Enter name + phone");

  const rows = [...cartWrap.querySelectorAll(".cartRow")];
  if(!rows.length) return alert("Add at least 1 bracelet");

  // build items (validation)
  let items = [];
  try{
    items = rows.map((row,i)=>{
      const typeId = row.querySelector(".typeSel").value;
      const size = (row.querySelector(".sizeSel").value || "").trim();
      const color1 = (row.querySelector(".c1Sel").value || "").trim();
      const color2 = (row.querySelector(".c2Sel").value || "").trim();

      const p = productsById[typeId];

      if(!typeId) throw new Error(`Pick a bracelet type for Bracelet ${i+1}`);
      if(!size) throw new Error(`Pick a size for Bracelet ${i+1}`);
      if(!color1 || !color2) throw new Error(`Pick both colors for Bracelet ${i+1}`);

      const unit = unitPriceForSize(p, size);

      return {
        productId: typeId,
        type: p?.type ?? "",
        size,
        color1,
        color2,
        unit
      };
    });
  }catch(err){
    return alert(err.message || String(err));
  }

  const createdAt = new Date();
  const groupId = `${createdAt.getTime()}-${Math.random().toString(16).slice(2)}`;

  let totalAll = 0;

  for(let i=0; i<items.length; i++){
    const it = items[i];
    totalAll += it.unit;

    await addDoc(collection(db,"braceletOrders"),{
      name,
      phone,
      type: it.type,
      size: it.size,
      color1: it.color1,
      color2: it.color2,

      qty: 1,
      price: it.unit,
      total: it.unit,

      status: "new",
      createdAt,

      // grouping helpers (optional)
      groupId,
      groupIndex: i+1,
      groupCount: items.length,

      productId: it.productId
    });
  }

  orderMsg.textContent = `Submitted ${items.length} orders! Total: $${totalAll.toFixed(2)}`;

  braceletForm.reset();
  cartWrap.innerHTML = "";
  rowCount = 0;
  addRow();       // start again with 1 row
  updateTotals();
};

/* INIT */
await loadProducts();
addRow();

addBraceletBtn.addEventListener("click", ()=>{
  if(rowCount >= MAX_ROWS) return alert("Max 4 bracelets");
  addRow();
});
</script>

</body>
</html>
