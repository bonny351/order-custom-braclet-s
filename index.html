<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tactics & Treats â€“ Full Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body{margin:0;padding:16px;background:#0b0b0b;color:#fff;font-family:Poppins}
.wrap{max-width:960px;margin:auto}
h1{color:#ff2a2a}
.chat{height:60vh;min-height:360px;background:#000;border-radius:14px;padding:12px;overflow:auto}
.msg{margin:8px 0;padding:10px 12px;border-radius:12px;white-space:pre-line}
.bot{background:#111;border:1px solid #2a2a2a}
.user{background:#1c1c1c;border:1px solid #333;margin-left:auto}
.bar{display:flex;gap:8px;margin-top:10px}
input{flex:1;padding:12px;border-radius:14px;background:#111;color:#fff;border:1px solid #2a2a2a}
button{padding:12px 16px;border-radius:14px;border:none;font-weight:800;background:#ff2a2a;color:#fff;cursor:pointer}
#status{font-size:12px;color:#ffb347;margin-top:6px}
</style>
</head>

<body>
<div class="wrap">
<h1>Tactics & Treats â€“ Full Admin Bot</h1>
<div id="chat" class="chat"></div>
<div id="status"></div>
<div class="bar">
  <input id="input" placeholder="Talk to me like ChatGPTâ€¦" />
  <button id="send">Send</button>
</div>
</div>

<!-- Firebase (compat = stable everywhere) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE (YOUR PROJECT) ================= */
firebase.initializeApp({
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
});
const db = firebase.firestore();
const ts = () => firebase.firestore.FieldValue.serverTimestamp();

/* ================= UI ================= */
const chat=document.getElementById("chat");
const input=document.getElementById("input");
const statusEl=document.getElementById("status");
function add(text,who="bot"){
  const d=document.createElement("div");
  d.className="msg "+(who==="user"?"user":"bot");
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}
function clean(s){return String(s||"").trim()}
function digits(s){return String(s||"").replace(/\D/g,"")}

/* ================= STATE ================= */
const convo={
  lastOrder:null,
  awaitingConfirm:null,
  awaitingAction:null
};

/* ================= FAST CACHE ================= */
let orderCache=[], cacheAt=0;
const CACHE_TTL=15000;

async function getOrders(){
  if(Date.now()-cacheAt<CACHE_TTL && orderCache.length) return orderCache;
  const snap=await db.collection("tt_orders").limit(500).get();
  orderCache=snap.docs.map(d=>({id:d.id,...d.data()}));
  cacheAt=Date.now();
  return orderCache;
}

/* ================= SKILLS ================= */
async function loadSkills(){
  const s=await db.collection("tt_skills").get();
  return s.docs.map(d=>d.data());
}
async function saveSkill(trigger,action){
  await db.collection("tt_skills").add({trigger,action,createdAt:ts()});
}

/* ================= TRANSLATION ================= */
function translate(text){
  text=text.toLowerCase();

  if(text.includes("how much")||text.includes("gross")||text.includes("revenue")){
    if(text.includes("month")) return "REVENUE_MONTH";
    if(text.includes("week")) return "REVENUE_WEEK";
    return "REVENUE_MONTH";
  }

  if(text.includes("fake")&&text.includes("order")) return "MAKE_FAKE";
  if(text.includes("next")) return "NEXT";
  if(text.includes("mark")&&text.includes("done")) return "DONE";

  return null;
}

/* ================= UNDERSTAND ================= */
async function understand(text){
  const L=text.toLowerCase();

  // yes/no learning
  if(convo.awaitingConfirm){
    if(["yes","yeah","yep","ok","sure"].includes(L)){
      convo.awaitingAction=convo.awaitingConfirm;
      convo.awaitingConfirm=null;
      return "__ASK_ACTION__";
    }
    if(["no","nope","nah"].includes(L)){
      convo.awaitingConfirm=null;
      return "__CANCEL__";
    }
  }

  // explain action
  if(convo.awaitingAction){
    const action=translate(text);
    if(action){
      await saveSkill(convo.awaitingAction,action);
      convo.awaitingAction=null;
      return "__LEARNED__";
    }
    return "__ASK_ACTION__";
  }

  // learned skills first
  const skills=await loadSkills();
  for(const s of skills){
    if(L.includes(s.trigger)) return s.action;
  }

  // built-ins
  if(L.includes("next")) return "NEXT";
  if(L.includes("fake")) return "MAKE_FAKE";
  if(L.includes("done")) return "DONE";

  // unknown
  convo.awaitingConfirm=text;
  return "__UNKNOWN__";
}

/* ================= EXECUTE ================= */
async function run(cmd){
  if(cmd==="__UNKNOWN__"){
    add(`I donâ€™t understand that ðŸ¤”

Do you want me to learn it?
"${convo.awaitingConfirm}"

Reply yes or no.`);
    return;
  }

  if(cmd==="__ASK_ACTION__"){
    add(`What should I do when you say:
"${convo.awaitingAction}"`);
    return;
  }

  if(cmd==="__LEARNED__"){
    add("âœ… Learned and saved. Iâ€™ll remember that.");
    return;
  }

  if(cmd==="__CANCEL__"){
    add("Okay ðŸ‘ I wonâ€™t learn that.");
    return;
  }

  if(cmd==="MAKE_FAKE"){
    const id="TEST_"+Math.random().toString(36).slice(2,7);
    await db.collection("tt_orders").doc(id).set({
      fake:true,
      status:"new",
      createdAt:ts(),
      totals:{total:25}
    });
    cacheAt=0;
    add(`ðŸ§ª Fake order created: ${id}`);
    return;
  }

  if(cmd==="NEXT"){
    const o=(await getOrders()).find(o=>o.status!=="done");
    if(!o){add("No orders left ðŸŽ‰");return;}
    convo.lastOrder=o.id;
    add(`Next order:\n${o.id}`);
    return;
  }

  if(cmd==="DONE"){
    if(!convo.lastOrder){add("Which order?");return;}
    await db.collection("tt_orders").doc(convo.lastOrder)
      .update({status:"done",doneAt:ts()});
    cacheAt=0;
    add(`âœ… Marked ${convo.lastOrder} done`);
    return;
  }

  if(cmd==="REVENUE_MONTH"){
    const rows=await getOrders();
    const sum=rows.filter(r=>r.status==="done")
      .reduce((a,b)=>a+(b.totals?.total||0),0);
    add(`ðŸ“Š Monthly gross: $${sum.toFixed(2)}`);
    return;
  }

  add("Iâ€™m not sure what to do with that yet.");
}

/* ================= SEND ================= */
async function send(){
  const t=clean(input.value);
  if(!t) return;
  input.value="";
  add(t,"user");
  const cmd=await understand(t);
  await run(cmd);
}
document.getElementById("send").onclick=send;
input.onkeydown=e=>e.key==="Enter"&&send();

/* ================= START ================= */
add(`Howdy ðŸ¤ 

You are in FULL ADMIN mode.

Examples:
â€¢ what's next
â€¢ mark it done
â€¢ make a fake order
â€¢ monthly gross
â€¢ make it so when I say monthly gross tell me how much I made that month
`);
</script>
</body>
</html>
