<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tactics & Treats ‚Äì Admin Bot</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0b0b; --panel:#141414; --panel2:#0f0f0f;
  --text:#fff; --muted:#c9c9c9; --accent:#ff2a2a;
  --line:#2a2a2a; --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0; padding:16px;
  background:var(--bg); color:var(--text);
  font-family:Poppins,system-ui;
}
.wrap{max-width:960px;margin:auto}
h1{color:var(--accent);margin:0 0 10px}
.card{
  background:var(--panel);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:0 0 20px rgba(255,0,0,.2);
}
.chat{
  height:60vh; min-height:360px;
  background:#000; border-radius:14px;
  padding:12px; overflow:auto;
}
.msg{
  margin:8px 0; padding:10px 12px;
  border-radius:12px; white-space:pre-line;
}
.bot{background:#111;border:1px solid #2a2a2a}
.user{background:#1c1c1c;border:1px solid #333;margin-left:auto}
.bar{display:flex;gap:8px;margin-top:10px}
input{
  flex:1;padding:12px;border-radius:14px;
  background:var(--panel2);color:#fff;border:1px solid var(--line)
}
button{
  padding:12px 16px;border-radius:14px;
  background:var(--accent);color:#fff;
  font-weight:800;border:none;cursor:pointer
}
button.secondary{background:#333}
#status{margin-top:6px;color:#ffb347;font-size:13px}
</style>
</head>

<body>
<div class="wrap">
<h1>Tactics & Treats ‚Äì Admin Bot</h1>

<div class="card">
  <div id="chat" class="chat"></div>
  <div id="status"></div>

  <div class="bar">
    <input id="input" placeholder="Talk to me‚Ä¶" />
    <button id="sendBtn">Send</button>
    <button id="resetBtn" class="secondary">Reset</button>
  </div>
</div>
</div>

<!-- Firebase compat (NO MODULES) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

<script>
/* =====================
   üî• FIREBASE CONFIG
   (PASTE YOUR REAL ONE)
===================== */
const firebaseConfig = {
  apiKey: "PASTE_YOURS",
  authDomain: "PASTE_YOURS",
  projectId: "PASTE_YOURS",
  storageBucket: "PASTE_YOURS",
  messagingSenderId: "PASTE_YOURS",
  appId: "PASTE_YOURS"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const ts = () => firebase.firestore.FieldValue.serverTimestamp();

/* =====================
   UI HELPERS
===================== */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const statusEl = document.getElementById("status");

function addMsg(text, who="bot"){
  const d=document.createElement("div");
  d.className="msg "+(who==="user"?"user":"bot");
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}
function setStatus(t){statusEl.textContent=t||""}
function clean(s){return String(s||"").trim()}
function digits(s){return String(s||"").replace(/\D/g,"")}

/* =====================
   CONVERSATION MEMORY
===================== */
const convo={
  lastOrderId:null,
  pending:null
};

/* =====================
   ORDER HELPERS
===================== */
async function getOrder(id){
  const snap=await db.collection("tt_orders").doc(id).get();
  return snap.exists? snap.data():null;
}
async function setOrder(id,patch){
  await db.collection("tt_orders").doc(id).update(patch);
}
async function getOrders(){
  const snap=await db.collection("tt_orders").limit(500).get();
  return snap.docs.map(d=>({id:d.id,...d.data()}));
}

/* =====================
   INTENT DETECTION
===================== */
function extractId(text){
  return text.split(/\s+/).find(t=>t.length>=4 && /\w/.test(t))||"";
}

async function understand(text){
  const L=text.toLowerCase();

  if(convo.pending){
    const id=extractId(text);
    if(id){
      const act=convo.pending;
      convo.pending=null;
      return `${act} ${id}`;
    }
    return "__ASK_ID__";
  }

  if(L.includes("next")) return "NEXT";
  if(L.includes("unpaid")) return "UNPAID";
  if(L.includes("unfinished")||L.includes("open")) return "UNFINISHED";

  if(L.includes("mark")&&(L.includes("done")||L.includes("complete"))){
    const id=extractId(text)||convo.lastOrderId;
    if(id) return `DONE ${id}`;
    convo.pending="DONE"; return "__ASK_ID__";
  }

  if(L.includes("ship")){
    const id=extractId(text)||convo.lastOrderId;
    if(id) return `SHIPPED ${id}`;
    convo.pending="SHIPPED"; return "__ASK_ID__";
  }

  const phone=digits(text);
  if(phone.length>=7) return `BYPHONE ${phone}`;

  return `FIND ${text}`;
}

/* =====================
   COMMAND EXECUTION
===================== */
async function run(cmd){
  const parts=cmd.split(" ");
  const c=parts[0];

  if(cmd==="__ASK_ID__"){
    addMsg("Which order?", "bot"); return;
  }

  if(c==="NEXT"){
    const rows=await getOrders();
    const r=rows.find(o=>o.status!=="done");
    if(!r){addMsg("No orders left üéâ");return;}
    convo.lastOrderId=r.id;
    addMsg(`Next order:\n${r.id}`, "bot");
    return;
  }

  if(c==="DONE"){
    const id=parts[1];
    await setOrder(id,{status:"done",doneAt:ts()});
    convo.lastOrderId=id;
    addMsg(`‚úÖ Marked ${id} done`, "bot");
    return;
  }

  if(c==="SHIPPED"){
    const id=parts[1];
    await setOrder(id,{shippedAt:ts()});
    convo.lastOrderId=id;
    addMsg(`üì¶ Marked ${id} shipped`, "bot");
    return;
  }

  if(c==="BYPHONE"){
    const rows=await getOrders();
    const out=rows.filter(r=>digits(r.order?.phone)===parts[1]);
    addMsg(out.map(o=>o.id).join("\n")||"None", "bot");
    return;
  }

  if(c==="FIND"){
    const rows=await getOrders();
    const q=cmd.slice(5).toLowerCase();
    const out=rows.filter(r=>JSON.stringify(r).toLowerCase().includes(q));
    addMsg(out.map(o=>o.id).join("\n")||"None", "bot");
    return;
  }

  addMsg("I didn‚Äôt get that.", "bot");
}

/* =====================
   SEND
===================== */
async function send(){
  const t=clean(input.value);
  if(!t) return;
  input.value="";
  addMsg(t,"user");
  const cmd=await understand(t);
  await run(cmd);
}

document.getElementById("sendBtn").onclick=send;
input.onkeydown=e=>e.key==="Enter"&&send();
document.getElementById("resetBtn").onclick=()=>{
  chat.innerHTML="";
  convo.lastOrderId=null;
  convo.pending=null;
  addMsg("Reset üëç","bot");
};

/* =====================
   START
===================== */
addMsg("Howdy ü§†\nTalk to me like a person.\n\nExamples:\n‚Ä¢ what‚Äôs next\n‚Ä¢ mark it done\n‚Ä¢ ship that order\n‚Ä¢ orders from 2083043821","bot");
</script>
</body>
</html>
