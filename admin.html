<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactics & Treats â€“ Admin</title>

<style>
:root{
  --bg:#0b0b0b;
  --panel:#141414;
  --line:#2a2a2a;
  --accent:#ff2a2a;
  --muted:#bdbdbd;
}
body{
  margin:0;
  padding:14px;
  background:var(--bg);
  color:#fff;
  font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
}
h1{ color:var(--accent); margin-bottom:10px; }

.row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

.panel{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  margin-bottom:14px;
}

.filters{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.filter{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#1a1a1a;
  font-size:13px;
  cursor:pointer;
}
.filter.active{ background:var(--accent); }

.order{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
}
.status{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--line);
}
.new{ background:#331111; }
.inprogress{ background:#332200; }
.paid{ background:#113311; }
.shipped{ background:#112233; }
.done{ background:#222; }

.small{ font-size:12px; color:var(--muted); line-height:1.4; }

.actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
button{
  border:none;
  border-radius:10px;
  padding:6px 12px;
  font-weight:800;
  cursor:pointer;
  background:var(--accent);
  color:#fff;
}
button.secondary{
  background:#222;
  border:1px solid #333;
}

textarea{
  width:100%;
  margin-top:8px;
  border-radius:10px;
  border:1px solid #333;
  background:#000;
  color:#fff;
  padding:8px;
  font-size:13px;
}
</style>
</head>

<body>

<h1>Tactics & Treats â€“ Admin</h1>

<!-- STATS -->
<div class="panel">
  <div class="row">
    <div><strong>Today:</strong> <span id="todayTotal">$0</span></div>
    <div><strong>This Month:</strong> <span id="monthTotal">$0</span></div>
    <div><strong>Avg / Month:</strong> <span id="avgMonth">$0</span></div>
    <div><strong>Paid Orders:</strong> <span id="paidCount">0</span></div>
  </div>
</div>

<!-- BEST SELLERS -->
<div class="panel">
  <div class="row">
    <div><strong>Top Weave:</strong> <span id="topWeave">â€”</span></div>
    <div><strong>Top Size:</strong> <span id="topSize">â€”</span></div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="small">
      <strong>Weave Breakdown</strong><br>
      <span id="weaveBreakdown">â€”</span>
    </div>
    <div class="small">
      <strong>Size Breakdown</strong><br>
      <span id="sizeBreakdown">â€”</span>
    </div>
  </div>
</div>

<!-- FILTERS -->
<div class="filters">
  <div class="filter active" data-filter="all">All</div>
  <div class="filter" data-filter="rush">Rush</div>
  <div class="filter" data-filter="unpaid">Unpaid</div>
  <div class="filter" data-filter="today">Today</div>
</div>

<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, query, orderBy, onSnapshot,
  updateDoc, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ordersDiv = document.getElementById("orders");
let filter="all";
let cache=[];

/* HELPERS */
function money(n){ return "$"+(Number(n)||0).toFixed(2).replace(/\.00$/,""); }
function isToday(ts){
  if(!ts?.toDate) return false;
  return ts.toDate().toDateString()===new Date().toDateString();
}

/* FILTER UI */
document.querySelectorAll(".filter").forEach(f=>{
  f.onclick=()=>{
    document.querySelectorAll(".filter").forEach(x=>x.classList.remove("active"));
    f.classList.add("active");
    filter=f.dataset.filter;
    render();
  };
});

/* RENDER ORDERS */
function render(){
  ordersDiv.innerHTML="";
  cache.forEach(({id,o})=>{
    if(filter==="rush" && !o.order?.rush) return;
    if(filter==="unpaid" && ["paid","shipped","done"].includes(o.status)) return;
    if(filter==="today" && !isToday(o.createdAt)) return;

    const status=o.status||"new";
    const card=document.createElement("div");
    card.className="order";
    card.innerHTML=`
      <div class="row">
        <strong>${o.order?.name||"No name"}</strong>
        <span class="status ${status.replace(" ","")}">${status}</span>
        <strong>${money(o.totals?.total)}</strong>
      </div>

      <div class="small">
        ðŸ“ž ${o.order?.phone||""}<br>
        ðŸ“¦ ${o.order?.address||""}
      </div>

      <div class="small">
        ${o.items.map(i=>`â€¢ ${i.itemType} â€“ ${i.weave} â€“ ${i.inches}" â€“ ${i.colors.join("/")}`).join("<br>")}
      </div>

      <div class="actions">
        <button onclick="setStatus('${id}','in progress')">In Progress</button>
        <button onclick="setStatus('${id}','paid')">Paid</button>
        <button onclick="setStatus('${id}','shipped')">Shipped</button>
        <button class="secondary" onclick="setStatus('${id}','done')">Done</button>
      </div>

      <textarea placeholder="Admin notesâ€¦" onblur="saveNote('${id}',this.value)">${o.adminNote||""}</textarea>
    `;
    ordersDiv.appendChild(card);
  });
}

/* STATS */
function calculateStats(){
  const now=new Date();
  let today=0, month=0, paid=0;
  const monthly={};

  cache.forEach(({o})=>{
    if(!["paid","shipped","done"].includes(o.status)) return;
    if(!o.totals?.total) return;

    const amt=Number(o.totals.total);
    const ts=o.paidAt||o.createdAt;
    if(!ts?.toDate) return;

    const d=ts.toDate();
    paid++;

    if(isToday(ts)) today+=amt;
    if(d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear()) month+=amt;

    const key=`${d.getFullYear()}-${d.getMonth()+1}`;
    monthly[key]=(monthly[key]||0)+amt;
  });

  const avg=Object.values(monthly).length
    ? Object.values(monthly).reduce((a,b)=>a+b,0)/Object.keys(monthly).length
    : 0;

  todayTotal.textContent=money(today);
  monthTotal.textContent=money(month);
  avgMonth.textContent=money(avg);
  paidCount.textContent=paid;
}

/* BEST SELLERS */
function calculateBestSellers(){
  const weave={}, size={};

  cache.forEach(({o})=>{
    if(!["paid","shipped","done"].includes(o.status)) return;
    o.items.forEach(i=>{
      if(i.weave) weave[i.weave]=(weave[i.weave]||0)+1;
      if(i.inches){
        const s=`${i.inches}"`;
        size[s]=(size[s]||0)+1;
      }
    });
  });

  const topW=Object.entries(weave).sort((a,b)=>b[1]-a[1])[0];
  const topS=Object.entries(size).sort((a,b)=>b[1]-a[1])[0];

  topWeave.textContent=topW?`${topW[0]} (${topW[1]})`:"â€”";
  topSize.textContent=topS?`${topS[0]} (${topS[1]})`:"â€”";

  weaveBreakdown.innerHTML=Object.entries(weave).map(([k,v])=>`${k}: ${v}`).join("<br>")||"â€”";
  sizeBreakdown.innerHTML=Object.entries(size).map(([k,v])=>`${k}: ${v}`).join("<br>")||"â€”";
}

/* FIRESTORE */
onSnapshot(query(collection(db,"tt_orders"),orderBy("createdAt","desc")),snap=>{
  cache=[];
  snap.forEach(d=>cache.push({id:d.id,o:d.data()}));
  render();
  calculateStats();
  calculateBestSellers();
});

/* ACTIONS */
window.setStatus=async(id,status)=>{
  const data={status};
  if(status==="paid") data.paidAt=serverTimestamp();
  if(status==="shipped") data.shippedAt=serverTimestamp();
  await updateDoc(doc(db,"tt_orders",id),data);
};
window.saveNote=async(id,val)=>{
  await updateDoc(doc(db,"tt_orders",id),{adminNote:val});
};
</script>

</body>
</html>
