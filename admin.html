<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tactics & Treats â€“ Chat Order</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0b0b; --panel:#141414; --panel2:#0f0f0f;
    --text:#fff; --muted:#c9c9c9; --accent:#ff2a2a;
    --line:#2a2a2a; --radius:16px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0; padding:18px;
    background:var(--bg); color:var(--text);
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{ max-width:980px; margin:0 auto; }
  header{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; flex-wrap:wrap; margin-bottom:14px;
  }
  h1{ margin:0; color:var(--accent); font-size:22px; }
  .pill{
    font-size:12px; padding:6px 10px; border-radius:999px;
    background:#1f1f1f; border:1px solid #2a2a2a; color:var(--muted);
  }
  .card{
    background:var(--panel);
    border:1px solid #262626;
    border-radius:var(--radius);
    padding:14px;
    box-shadow:0 0 18px rgba(255,0,0,.18);
  }
  .chat{
    height:590px; overflow:auto;
    padding:12px;
    border-radius:14px;
    background:#000;
    border:1px solid var(--line);
  }
  .msg{
    max-width:92%;
    padding:10px 12px;
    border-radius:14px;
    margin:10px 0;
    white-space:pre-line;
    line-height:1.35;
  }
  .bot{
    background:#101010;
    border:1px solid #2a2a2a;
    border-top-left-radius:6px;
  }
  .user{
    background:#1c1c1c;
    border:1px solid #333;
    margin-left:auto;
    border-top-right-radius:6px;
  }
  .chips{
    display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
  }
  .chip{
    background:#191919;
    border:1px solid #2f2f2f;
    color:#fff;
    padding:8px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:13px;
    font-weight:800;
    user-select:none;
  }
  .chip:hover{ filter:brightness(1.08); }
  .bar{ display:flex; gap:10px; margin-top:10px; }
  input{
    flex:1;
    border:none; outline:none;
    border-radius:14px;
    padding:12px 12px;
    font-size:15px;
    color:#fff;
    background:var(--panel2);
    border:1px solid var(--line);
  }
  button{
    border:none;
    border-radius:14px;
    padding:12px 14px;
    font-weight:900;
    cursor:pointer;
    background:var(--accent);
    color:#fff;
  }
  button:hover{ filter:brightness(1.08); }
  .secondary{
    background:#242424;
    border:1px solid #343434;
    color:#fff;
  }
  .meta{ font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35; }
  #status{ margin-top:10px; color:#ffb347; font-weight:800; min-height:18px; }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <h1>Tactics & Treats â€“ Chat Order</h1>
    <div class="pill">CONFIRM submits â€¢ Auto-fill â€¢ Quote first</div>
  </header>

  <div class="card">
    <div id="chat" class="chat"></div>
    <div id="chips" class="chips"></div>
    <div id="status"></div>

    <div class="bar">
      <input id="input" placeholder="Type your messageâ€¦" autocomplete="off" />
      <button id="sendBtn">Send</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div class="meta">
      Commands: <b>BACK</b>, <b>RESTART</b>, <b>CONFIRM</b> (submits at the end)
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE */
const firebaseConfig = {
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ORDERS_COLLECTION = "tt_orders";

/* ========= BUSINESS RULES ========= */
const PRICE_PER_INCH = 1;
const MIN_IN = 5;
const MAX_IN = 40;

const SHIPPING_IN = 6;
const SHIPPING_OUT = 10;

const FEE_DURABILITY = 3;
const FEE_GLOW = 2;
const FEE_REFLECTIVE = 2;
const FEE_CHARM = 3;
const FEE_EXTRA_TAIL = 2;
const FEE_RUSH = 5; // (your order flow still uses this; FAQ rush is $1 as you stated)
const FEE_GIFT_NOTE = 2;
const FEE_ENGRAVED_TAG = 8;

const COUPON_CODE = "NORTHIDAHO";
const COUPON_PCT = 10;

const PHONE_NUMBER = "208-304-3821";
const SIGNATURE = "Tactics & Treats Team";

const POPULAR_PICK = "Most popular pick: King Cobra in red/black.";
const LIMITED_SPOTS = "Heads up: I can do same-day, but I have limited spots today.";

/* âœ… UPDATED BRAND STORY (locked) */
const BRAND_STORY =
`I started Tactics & Treats because I like making things by hand and wanted to turn that into something real. Everything is custom, made with care, and not mass-produced.

Quality over quantity. Weâ€™re not about the money â€” weâ€™re about making quality gear and making sure every customer is happy.

â€” ${SIGNATURE}`;

/* ========= UI ========= */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const chipsBox = document.getElementById("chips");
const statusEl = document.getElementById("status");

function setStatus(msg){ statusEl.textContent = msg || ""; }
function addMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = "msg " + (who === "user" ? "user" : "bot");
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function setChips(options){
  chipsBox.innerHTML = "";
  (options || []).forEach(opt=>{
    const b = document.createElement("div");
    b.className = "chip";
    b.textContent = opt;
    b.onclick = ()=>{ input.value = opt; send(); };
    chipsBox.appendChild(b);
  });
}
function clean(s){ return (s||"").toLowerCase(); }
function money(n){
  const x = Number(n);
  if(!isFinite(x)) return "$0";
  return "$" + x.toFixed(2).replace(/\.00$/,"");
}

/* âœ… NEW: LOG UNANSWERED QUESTIONS */
async function logUnanswered(text){
  try{
    await addDoc(collection(db,"tt_unanswered"),{
      text: String(text||"").trim(),
      createdAt: serverTimestamp()
    });
  }catch(e){}
}

/* âœ… OPTIONAL: ADMIN-EDITABLE FAQ (tt_faq)
   Doc format: { triggers:["shipping","deliver"], answer:"..." }
*/
let FAQ_DB = [];
async function loadFAQ(){
  try{
    const snap = await getDocs(collection(db,"tt_faq"));
    FAQ_DB = [];
    snap.forEach(d=>FAQ_DB.push(d.data()));
  }catch(e){
    FAQ_DB = [];
  }
}

/* ========= DATA ========= */
function makeItem(){
  return {
    itemType: "",
    weave: "",
    inches: 0,
    fit: "",
    colors: [],
    patternStyle: "",
    durability: false,
    glow: false,
    reflective: false,
    charm: false,
    extraTail: false,
    engravedTagText: ""
  };
}

let items = [makeItem()];

const order = {
  rush:false,
  giftNote:false,
  giftNoteText:"",
  donation:0,
  coupon:"",
  shipping:"",
  address:"",
  name:"",
  phone:"",
  photoBeforePay:false,
  notes:""
};

function needColorsCount(it){
  if(it.weave === "king cobra") return 3;
  if(it.weave === "cobra") return 2;
  return 0;
}

/* ========= PRICING ========= */
function itemBase(it){ return (Number(it.inches)||0) * PRICE_PER_INCH; }
function itemUpsells(it){
  let a = 0;
  if(it.durability) a += FEE_DURABILITY;
  if(it.glow) a += FEE_GLOW;
  if(it.reflective) a += FEE_REFLECTIVE;
  if(it.charm) a += FEE_CHARM;
  if(it.extraTail) a += FEE_EXTRA_TAIL;
  if(it.itemType==="dog collar" && it.engravedTagText) a += FEE_ENGRAVED_TAG;
  return a;
}
function orderUpsells(){
  let a = 0;
  if(order.rush) a += FEE_RUSH;
  if(order.giftNote) a += FEE_GIFT_NOTE;
  return a;
}
function shippingCost(){
  return order.shipping === "in" ? SHIPPING_IN : (order.shipping==="out" ? SHIPPING_OUT : 0);
}
function couponDiscount(subtotal){
  const code = String(order.coupon||"").trim().toUpperCase();
  if(!code) return 0;
  if(code !== COUPON_CODE) return 0;
  return subtotal * (COUPON_PCT/100);
}
function calcTotals(){
  const base = items.reduce((s,it)=>s+itemBase(it),0);
  const itemUp = items.reduce((s,it)=>s+itemUpsells(it),0);
  const orderUp = orderUpsells();
  const donation = Number(order.donation)||0;
  const ship = shippingCost();
  const subtotal = Math.max(0, base + itemUp + orderUp);
  const coup = couponDiscount(subtotal);
  const subtotalAfterCoupon = Math.max(0, subtotal - coup);
  const total = subtotalAfterCoupon + ship + donation;
  return { base, itemUpsells:itemUp, orderUpsells:orderUp, subtotal, coup, subtotalAfterCoupon, ship, donation, total };
}
function pricePreviewLine(){
  const t = calcTotals();
  return `Estimate so far: ${money(t.total)}${t.coup>0 ? ` (coupon -${money(t.coup)})` : ""}`;
}

/* ========= UPDATED FAQ / SALES ========= */
function answerFAQ(text){
  const t = clean(text);

  // 1) Firestore FAQ overrides (admin-editable)
  for(const f of FAQ_DB){
    if(f?.triggers?.some(k => t.includes(String(k).toLowerCase()))){
      return String(f.answer || "").trim() || null;
    }
  }

  // CONTACT
  if(t.includes("contact") || t.includes("number") || t.includes("phone")){
    return `Text: ${PHONE_NUMBER}\nâ€” ${SIGNATURE}`;
  }

  // BRAND / ABOUT
  if(t.includes("why did you start") || t.includes("your story") || (t.includes("why") && t.includes("start")) || t.includes("story")){
    return "I started Tactics & Treats because I like making things by hand and wanted to turn that into something real. Everything is custom, made with care, and not mass-produced.";
  }
  if(t.includes("who makes") || t.includes("handmade") || t.includes("team")){
    return "Everything is handmade by a small team, not mass-produced.";
  }
  if(t.includes("where are you") || t.includes("where based") || (t.includes("where") && t.includes("located"))){
    return "Iâ€™m currently based in Idaho. That may change in the future, but all orders ship from here for now.";
  }

  // PRODUCTS
  if(t.includes("what do you sell") || t.includes("what do you make") || t.includes("what do you do")){
    return "I make custom paracord bracelets, dog collars, and keychains â€” all handmade and sized to order.";
  }
  if(t.includes("materials") || t.includes("made of") || t.includes("what are these made")){
    return "I use 550 paracord and micro cord, along with metal or plastic buckles and metal charms or rings, depending on the item.";
  }
  if(t.includes("survival") || t.includes("edc") || t.includes("just for looks")){
    return "Theyâ€™re made with real paracord and can be used as survival gear, not just for looks.";
  }
  if((t.includes("keychain") || t.includes("dog collar")) && (t.includes("same") || t.includes("materials"))){
    return "Yes, the bracelets, keychains, and dog collars are all made using the same quality cord and materials.";
  }

  // DOG COLLARS
  if(t.includes("dog collar") && (t.includes("adjustable") || t.includes("fixed"))){
    return "Dog collars are fixed size and made to the measurement you provide.";
  }
  if(t.includes("dog") && (t.includes("size") || t.includes("measure") || t.includes("collar"))){
    return "The best way to size a dog collar is to use a fabric measuring tape, put it snug around your dogâ€™s neck, then add about one inch for comfort.";
  }

  // WATER / DAILY USE
  if(t.includes("water") || t.includes("wet") || t.includes("rain") || t.includes("sweat") || t.includes("swim") || t.includes("shower")){
    return "Theyâ€™re fine for daily wear and can handle sweat, rain, and getting wet. Swimming and showering are okay, but I wouldnâ€™t recommend it regularly since dirt can build up under the bracelet over time.";
  }

  // LIFESPAN
  if(t.includes("how long") || t.includes("lifespan") || t.includes("last") || t.includes("wear out")){
    return "It really depends on how itâ€™s worn and used. With normal wear they can last a long time, but heavy use will wear them out faster.";
  }

  // SIZING
  if((t.includes("adult") && t.includes("size")) || t.includes("adult wrist")){
    return "Most adults usually wear between about 7.5 and 8.5 inches, but measuring your wrist is always best.";
  }
  if((t.includes("teen") && (t.includes("size") || t.includes("sizing"))) || t.includes("teen wrist")){
    return "Teens usually fall around 6.5â€“7.5 inches, but it can vary a lot depending on wrist size.";
  }
  if(t.includes("between sizes") || (t.includes("between") && t.includes("size"))){
    return "If youâ€™re between sizes, ask me for the most common sizes. A good rule is to go about 0.5 inches under the next size up for a comfortable fit.";
  }
  if(t.includes("measure") && (t.includes("wrist") || t.includes("fit"))){
    return "Measure your wrist with a tape or string. Pick snug/regular/loose depending on how you like it to fit.";
  }

  // CUSTOM / BULK / LIMITS
  if(t.includes("custom") || t.includes("special request") || t.includes("bulk") || t.includes("group") || t.includes("matching set")){
    return "Yes â€” custom color combos, custom sizes, matching sets (bracelet + dog collar), and bulk or group orders are all available.";
  }
  if(t.includes("logo") || t.includes("copyright") || t.includes("hate") || t.includes("offensive") || t.includes("unsafe") || t.includes("harmful")){
    return "I donâ€™t make copyrighted logos, hate symbols, offensive content, or anything unsafe or harmful.";
  }

  // ORDER CHANGES / ISSUES
  if((t.includes("change") || t.includes("edit")) && t.includes("order")){
    return `Yes, you can change your order as long as it hasnâ€™t been made yet. To check, text ${PHONE_NUMBER} and Iâ€™ll let you know.`;
  }
  if(t.includes("wrong size") || t.includes("wrong address")){
    return "If you entered the wrong size or address, contact me as soon as possible. Address issues can usually be fixed, and size changes depend on how far along the order is.";
  }
  if(t.includes("break") || t.includes("broke")){
    return "If it breaks within 2 weeks and it doesnâ€™t look like it was pulled apart on purpose, Iâ€™ll replace it. Replacement requires the optional insurance, which is an extra $2.";
  }

  // PAYMENT
  if(t.includes("pay") || t.includes("payment") || t.includes("card") || t.includes("cash")){
    return "I accept card payments and cash. Payment is required before I make the item.";
  }
  if(t.includes("tip") || t.includes("donation")){
    return "Yes, tips or donations are optional and always appreciated, but never required.";
  }

  // SHIPPING
  if(t.includes("ship") || t.includes("shipping") || t.includes("deliver")){
    return "Shipping time depends on your location. Iâ€™ll give you an estimate once your order is ready to ship.";
  }
  if(t.includes("international") || t.includes("outside the us") || (t.includes("outside") && t.includes("u.s"))){
    return "Not right now, but I may offer shipping outside the U.S. in the future.";
  }

  // PICKUP / MEETUPS (locked)
  if(t.includes("pickup") || t.includes("meet") || t.includes("meet up")){
    return "Local pickup may be available sometimes. Just ask and Iâ€™ll let you know whatâ€™s possible.";
  }

  // RUSH (locked: $1, limited, same-day making)
  if(t.includes("rush") || t.includes("same day")){
    if(t.includes("not available") || t.includes("no rush")){
      return "If rush isnâ€™t available, the order will be made as a normal order.";
    }
    return "Rush means same-day making if available. Thereâ€™s a $1 extra fee, and spots are limited.";
  }

  // REFUNDS
  if(t.includes("refund")){
    return "Refunds are only offered if thereâ€™s a mistake on my end.";
  }

  // UPSET CUSTOMERS
  if(t.includes("not happy") || t.includes("upset") || t.includes("angry") || t.includes("mad")){
    return `Iâ€™m sorry youâ€™re having an issue. Please text ${PHONE_NUMBER} and Iâ€™ll do my best to help.`;
  }

  // TRUST
  if(t.includes("amazon") || t.includes("why buy") || t.includes("why you") || t.includes("mass produced")){
    return "Everything I make is handmade, not mass-produced. That means better materials, tighter builds, and more attention to detail, which makes them stronger and better overall.";
  }

  // COLORS (general helper)
  if(t.includes("color") || t.includes("colors")){
    return `Cobra = 2 colors â€¢ King Cobra = 3 colors.\nTell me the weave and the colors you want (example: "king cobra red/black/white").\n\n${POPULAR_PICK}`;
  }

  // PRICE
  if(t.includes("price") || t.includes("how much") || t.includes("cost")){
    return `Pricing is $${PRICE_PER_INCH}/inch (sizes ${MIN_IN}-${MAX_IN}).\nShipping: $${SHIPPING_IN} in-state / $${SHIPPING_OUT} out-of-state.\n\n${POPULAR_PICK}\n${LIMITED_SPOTS}`;
  }

  return null;
}

function wantsToBuy(text){
  const t = clean(text);
  const intent =
    t.includes("i want") || t.includes("ill take") || t.includes("i'll take") ||
    t.includes("ill get") || t.includes("i'll get") ||
    t.includes("order") || t.includes("buy") || t.includes("get one") ||
    t.includes("could i") || t.includes("can i") || t.includes("can you");
  const product =
    t.includes("cobra") || t.includes("bracelet") || t.includes("collar") || t.includes("paracord") || t.includes("micro");
  return intent && product;
}

/* ========= PARSING HELPERS ========= */
function extractWeave(seg){
  if(/king\s*cobra/i.test(seg)) return "king cobra";
  if(/\bcobra\b/i.test(seg)) return "cobra";
  return "";
}

function extractInches(seg){
  let m = seg.match(/(\d+(?:\.\d+)?)\s*(?:inches|inch|in|")/i) || seg.match(/\bsize\s*(\d+(?:\.\d+)?)/i);
  if(m) return Number(m[1]);
  const m2 = seg.match(/\b(\d+(?:\.\d+)?)\b/);
  return m2 ? Number(m2[1]) : 0;
}

function extractColors(seg, wantCount){
  let colors = [];
  if(seg.includes(",")){
    colors = seg.split(",").map(x=>x.trim()).filter(Boolean);
  }else{
    const slash = seg.match(/\b([a-z]+)\s*\/\s*([a-z]+)(?:\s*\/\s*([a-z]+))?\b/i);
    if(slash){
      colors = [slash[1], slash[2], slash[3]].filter(Boolean);
    }else{
      const and3 = seg.match(/\b([a-z]+)\b\s*(?:and)\s*\b([a-z]+)\b\s*(?:and)\s*\b([a-z]+)\b/i);
      const and2 = seg.match(/\b([a-z]+)\b\s*(?:and)\s*\b([a-z]+)\b/i);
      if(and3) colors = [and3[1], and3[2], and3[3]];
      else if(and2) colors = [and2[1], and2[2]];
      else{
        const words = seg.replace(/[^a-z\s]/gi," ").split(/\s+/).map(w=>w.trim()).filter(Boolean);
        const stop = new Set([
          "inches","inch","in","is","and","a","the","one","two","three","four",
          "cobra","king","bracelet","bracelets","i","want","size","with","colors",
          "outside","middle","band","inside","pattern","weave"
        ]);
        const filtered = words.filter(w=>!stop.has(w.toLowerCase()));
        if(filtered.length >= 2) colors = filtered.slice(0, Math.max(2, wantCount || 2));
      }
    }
  }

  colors = colors.map(c=>c.toLowerCase());
  if(wantCount) colors = colors.slice(0, wantCount);
  return colors;
}

function extractFit(seg){
  const t = clean(seg);
  if(t.includes("snug")) return "snug";
  if(t.includes("loose")) return "loose";
  if(t.includes("regular")) return "regular";
  return "";
}

function extractAddons(seg){
  return {
    durability: /\bdurable\b|\bdurability\b|\bsurvival\b|\bsurviv(?:al|le)\b/i.test(seg),
    glow: /\bglow\b|\bglow[-\s]?in[-\s]?the[-\s]?dark\b/i.test(seg),
    reflective: /\breflective\b/i.test(seg),
    charm: /\bcharm\b/i.test(seg),
    extraTail: /\bextra\s*tail\b|\blonger\s*tail\b/i.test(seg),
    rush: /\brush\b|\bsame[-\s]?day\b|\btoday\b|\bpriority\b/i.test(seg),
  };
}

function parseDonation(text){
  const m = String(text||"").match(/donat(?:e|ion)\s*\$?\s*(\d+(?:\.\d+)?)/i);
  return m ? Number(m[1]) : null;
}

/* ========= MULTI-ITEM MESSAGE PARSER ========= */
function parseMultiBraceletMessage(text){
  const raw = String(text || "");
  const t = raw.toLowerCase();

  const asksPrice = /(price|cost|how much|total|quote|estimate)/i.test(raw);
  const looksMulti =
    /(bracelet\s*1|bracelet\s*2|bracelet\s*3|bracelet\s*4)/i.test(raw) ||
    /(2|two|3|three|4|four)\s+(bracelets|bracelet)/i.test(raw) ||
    /\bone of them\b|\bthe other\b|\bsecond\b|\bfirst\b/i.test(raw);

  if(!asksPrice && !looksMulti) return null;

  const orderHints = {
    rush: /\brush\b|\bsame[-\s]?day\b|\btoday\b|\bpriority\b/i.test(raw),
    donation: parseDonation(raw)
  };

  let segments = [];
  if(/bracelet\s*\d/i.test(t)){
    segments = raw.split(/bracelet\s*\d+\s*[:\-]?\s*/i).map(s=>s.trim()).filter(Boolean);
  }else{
    segments = raw.split(/(?:\bone of them\b|\bthe other\b|\bsecond\b|\bfirst\b|\bone\b)\s*(?:is)?\s*/i)
      .map(s=>s.trim()).filter(Boolean);
  }
  if(segments.length < 2) return null;

  const out = [];

  for(const seg of segments){
    const weave = extractWeave(seg);
    const inches = extractInches(seg);
    if(!weave || !inches) continue;

    const need = (weave === "king cobra") ? 3 : 2;
    const colors = extractColors(seg, need);
    const fit = extractFit(seg) || "regular";
    const add = extractAddons(seg);

    out.push({
      itemType: "bracelet",
      weave,
      inches,
      fit,
      colors,
      patternStyle: "stripes",
      durability: !!add.durability,
      glow: !!add.glow,
      reflective: !!add.reflective,
      charm: !!add.charm,
      extraTail: !!add.extraTail,
      engravedTagText: ""
    });

    if(add.rush) orderHints.rush = true;
  }

  if(out.length < 2) return null;
  return { items: out, asksPrice, orderHints };
}

/* ========= SINGLE-MESSAGE AUTO FILL ========= */
function extractHints(text){
  const t = clean(text);
  const h = { itemType:null, weave:null, colors:null, inches:null, fit:null, addons:null };

  if(t.includes("dog") && t.includes("collar")) h.itemType="dog collar";
  else if(t.includes("collar")) h.itemType="dog collar";
  else if(t.includes("keychain")) h.itemType="keychain";
  else if(t.includes("bracelet")) h.itemType="bracelet";

  if(t.includes("king cobra")) h.weave="king cobra";
  else if(t.includes("cobra")) h.weave="cobra";

  const inches = extractInches(text);
  if(inches) h.inches = inches;

  const fit = extractFit(text);
  if(fit) h.fit = fit;

  h.addons = extractAddons(text);

  const outside = t.match(/outside\s+([a-z]+)/);
  const middle  = t.match(/middle\s+(?:band\s+)?([a-z]+)/);
  const inside  = t.match(/inside\s+([a-z]+)/);
  if(outside && middle && inside){
    h.colors=[outside[1], middle[1], inside[1]];
    return h;
  }

  let guessedWeave = h.weave;
  if(!guessedWeave){
    const temp3 = extractColors(text, 3);
    const temp2 = extractColors(text, 2);
    if(temp3.length === 3) guessedWeave = "king cobra";
    else if(temp2.length === 2) guessedWeave = "cobra";
  }
  const want = guessedWeave === "king cobra" ? 3 : (guessedWeave === "cobra" ? 2 : 0);
  if(want){
    const c = extractColors(text, want);
    if(c.length === want) h.colors = c;
  }

  return h;
}

function applyHintsToItem(h, it){
  if(h.itemType && !it.itemType) it.itemType = h.itemType;
  if(h.weave && !it.weave) it.weave = h.weave;
  if(h.inches && !it.inches) it.inches = h.inches;
  if(h.fit && !it.fit) it.fit = h.fit;

  if(h.colors && h.colors.length){
    if(!it.weave){
      if(h.colors.length===3) it.weave="king cobra";
      if(h.colors.length===2) it.weave="cobra";
    }
    const need = needColorsCount(it);
    if(need && it.colors.length===0 && h.colors.length===need){
      it.colors = h.colors.slice(0,need);
    }
  }

  if(h.addons){
    if(h.addons.durability) it.durability = true;
    if(h.addons.glow) it.glow = true;
    if(h.addons.reflective) it.reflective = true;
    if(h.addons.charm) it.charm = true;
    if(h.addons.extraTail) it.extraTail = true;
    if(h.addons.rush) order.rush = true;
  }

  const don = parseDonation(JSON.stringify(h) + " " + JSON.stringify(it));
  if(typeof don === "number" && isFinite(don)) order.donation = don;
}

/* ========= FLOW ========= */
let mode = "sales";
let stepIndex = 0;
const backStack = [];
let skipCoupon = false;
let skipDonation = false;

/* steps */
const steps = [
  { key:"itemType", ask:"What do you want? (bracelet, dog collar, keychain)", chips:["bracelet","dog collar","keychain"],
    parse:v=>{ v=clean(v).trim(); return ["bracelet","dog collar","keychain"].includes(v)?v:null; },
    apply:v=> items[0].itemType=v
  },
  { key:"weave", ask:`Which weave? (cobra=2 colors, king cobra=3 colors)\n${POPULAR_PICK}`, chips:["cobra","king cobra"],
    parse:v=>{ v=clean(v).trim(); return (v==="cobra"||v==="king cobra")?v:null; },
    apply:v=> items[0].weave=v
  },
  { key:"inches", ask:`Size in inches (${MIN_IN}-${MAX_IN}) (you can type 8.5 or "size 8")`, chips:["6","7","8","8.5","9","10","12","14"],
    parse:v=>{
      const n = extractInches(String(v||""));
      return (isFinite(n) && n>=MIN_IN && n<=MAX_IN) ? n : null;
    },
    apply:v=> items[0].inches=v
  },
  { key:"fit", ask:"Fit? (snug, regular, loose)", chips:["snug","regular","loose"],
    parse:v=>{ v=clean(v).trim(); return ["snug","regular","loose"].includes(v)?v:null; },
    apply:v=> items[0].fit=v
  },
  { key:"colors", ask:"Colors? Cobra=2 (ex: red, black) â€¢ King Cobra=3 (ex: white, black, white)", chips:["red, black","white, black, white","camo, black"],
    parse:v=>{
      const need = needColorsCount(items[0]);
      if(!need) return null;
      const parts = extractColors(String(v||""), need);
      return (parts.length===need) ? parts : null;
    },
    apply:v=> items[0].colors=v
  },
  { key:"patternStyle", ask:"Pattern style? (stripes, split, fade, chevron)", chips:["stripes","split","fade","chevron"],
    parse:v=>{ v=clean(v).trim(); return ["stripes","split","fade","chevron"].includes(v)?v:null; },
    apply:v=> items[0].patternStyle=v
  },
  { key:"durability", ask:`Durability / survival cord upgrade? (+$${FEE_DURABILITY})`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=> items[0].durability=v
  },
  { key:"reflective", ask:`Reflective cord option? (+$${FEE_REFLECTIVE})`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=> items[0].reflective=v
  },
  { key:"glow", ask:`Glow option? (+$${FEE_GLOW})`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=> items[0].glow=v
  },
  { key:"charm", ask:`Add a charm? (+$${FEE_CHARM})`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=> items[0].charm=v
  },
  { key:"extraTail", ask:`Extra tail/length? (+$${FEE_EXTRA_TAIL})`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=> items[0].extraTail=v
  },
  { key:"engravedTagAsk", ask:`If this is a dog collar, do you want an engraved tag? (+$${FEE_ENGRAVED_TAG})`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=>{
      if(items[0].itemType!=="dog collar"){ items[0].engravedTagText=""; return; }
      if(v===false) items[0].engravedTagText="";
    }
  },
  { key:"engravedTagText", ask:'Engraved tag text (name + phone). If none, type: none', chips:["none"],
    parse:v=>{ v=String(v||"").trim(); if(clean(v)==="none") return ""; return v.length>=2 ? v : null; },
    apply:v=>{ if(items[0].itemType==="dog collar") items[0].engravedTagText=v; }
  },
  { key:"rush", ask:`Rush (same-day priority) (+$${FEE_RUSH})?`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=> order.rush=v
  },
  { key:"giftAsk", ask:`Add a gift note? (+$${FEE_GIFT_NOTE})`, chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=>{ order.giftNote=v; if(!v) order.giftNoteText=""; }
  },
  { key:"giftText", ask:"Gift note text (or none)", chips:["none"],
    parse:v=>{ v=String(v||"").trim(); if(clean(v)==="none") return ""; return v.length>=2 ? v : null; },
    apply:v=>{ if(order.giftNote) order.giftNoteText=v; }
  },
  { key:"couponAsk", ask:"Have a coupon code? (yes/no)", chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=>{ skipCoupon = (v===false); if(skipCoupon) order.coupon=""; }
  },
  { key:"coupon", ask:`Enter coupon code (or none). Example: ${COUPON_CODE}`, chips:[COUPON_CODE,"none"],
    parse:v=>{ v=String(v||"").trim(); if(clean(v)==="none") return ""; return v; },
    apply:v=> order.coupon=v
  },
  { key:"donateAsk", ask:"Would you like to add a donation? (optional)", chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=>{ skipDonation = (v===false); if(skipDonation) order.donation=0; }
  },
  { key:"donation", ask:"Donation amount (0, 1, 3, 5, 10, etc.)", chips:["0","1","3","5","10"],
    parse:v=>{ const n=Number(String(v).replace(/[^\d.]/g,"")); return (isFinite(n)&&n>=0)?n:null; },
    apply:v=> order.donation=v
  },
  { key:"shipping", ask:`Shipping: in-state or out-of-state?\n$${SHIPPING_IN} in-state / $${SHIPPING_OUT} out-of-state`, chips:["in-state","out-of-state"],
    parse:v=>{ v=clean(v).trim(); if(v==="in-state")return "in"; if(v==="out-of-state")return "out"; return null; },
    apply:v=> order.shipping=v
  },
  { key:"address", ask:"Shipping address (Street, City, State, ZIP)", chips:[],
    parse:v=>{ v=String(v||"").trim(); return v.length>=10 ? v : null; },
    apply:v=> order.address=v
  },
  { key:"name", ask:"Name for the order", chips:[],
    parse:v=>{ v=String(v||"").trim(); return v.length>=2 ? v : null; },
    apply:v=> order.name=v
  },
  { key:"phone", ask:"Phone number", chips:[],
    parse:v=>{ const digits=String(v||"").replace(/[^\d]/g,""); return digits.length>=10 ? String(v).trim() : null; },
    apply:v=> order.phone=v
  },
  { key:"photoBeforePay", ask:"Want a photo before I send the pay link? (yes/no)", chips:["yes","no"],
    parse:v=>{ v=clean(v).trim(); if(v==="yes")return true; if(v==="no")return false; return null; },
    apply:v=> order.photoBeforePay=v
  },
  { key:"notes", ask:"Any notes? (or none)", chips:["none"],
    parse:v=>{ v=String(v||"").trim(); if(clean(v)==="none") return ""; return v; },
    apply:v=> order.notes=v
  }
];

function stepDone(key){
  const it = items[0];
  if(key==="itemType") return !!it.itemType;
  if(key==="weave") return !!it.weave;
  if(key==="inches") return !!it.inches;
  if(key==="fit") return !!it.fit;
  if(key==="colors"){
    const need = needColorsCount(it);
    return need>0 && it.colors.length===need;
  }
  if(key==="patternStyle") return !!it.patternStyle;
  if(key==="engravedTagAsk") return true;
  if(key==="engravedTagText") return (it.itemType!=="dog collar") ? true : (it.engravedTagText !== null);
  if(key==="giftText") return order.giftNote ? (order.giftNoteText.length>=0) : true;
  if(key==="coupon") return true;
  if(key==="donation") return true;
  if(key==="shipping") return !!order.shipping;
  if(key==="address") return !!order.address;
  if(key==="name") return !!order.name;
  if(key==="phone") return !!order.phone;
  return false;
}

function nextMissing(i){
  while(i < steps.length){
    const k = steps[i].key;

    if(k==="engravedTagAsk" && items[0].itemType!=="dog collar"){ i++; continue; }
    if(k==="engravedTagText" && items[0].itemType!=="dog collar"){ i++; continue; }
    if(k==="giftText" && !order.giftNote){ i++; continue; }
    if(k==="coupon" && skipCoupon){ i++; continue; }
    if(k==="donation" && skipDonation){ i++; continue; }

    if(!stepDone(k)) return i;
    i++;
  }
  return steps.length;
}

function askStep(){
  stepIndex = nextMissing(stepIndex);

  if(stepIndex >= steps.length){
    mode = "review";
    addMsg(buildSummary(), "bot");
    setChips(["CONFIRM","BACK","RESTART"]);
    addMsg("Type CONFIRM to submit.", "bot");
    return;
  }

  const s = steps[stepIndex];
  addMsg(s.ask, "bot");
  setChips(s.chips || []);
  addMsg(pricePreviewLine(), "bot");
}

function buildSummary(){
  const t = calcTotals();
  const it = items[0];
  const colors = (it.colors||[]).join(", ");
  const add = [];
  if(it.durability) add.push("durability");
  if(it.reflective) add.push("reflective");
  if(it.glow) add.push("glow");
  if(it.charm) add.push("charm");
  if(it.extraTail) add.push("extra tail");
  const addLine = add.length ? `\nâ€¢ Add-ons: ${add.join(", ")}` : "";
  const tag = (it.itemType==="dog collar" && it.engravedTagText) ? `\nâ€¢ Tag: ${it.engravedTagText}` : "";

  return (
`Order Summary
â€¢ Item: ${it.itemType}
â€¢ Weave: ${it.weave}
â€¢ Size: ${it.inches}"
â€¢ Fit: ${it.fit}
â€¢ Colors: ${colors}
â€¢ Pattern: ${it.patternStyle}${addLine}${tag}

â€¢ Rush: ${order.rush ? "yes" : "no"}
â€¢ Gift note: ${order.giftNote ? `yes (${order.giftNoteText || "blank"})` : "no"}
â€¢ Coupon: ${order.coupon || "none"}
â€¢ Donation: ${money(order.donation || 0)}
â€¢ Shipping: ${order.shipping === "in" ? "in-state" : "out-of-state"}
â€¢ Address: ${order.address}
â€¢ Name: ${order.name}
â€¢ Phone: ${order.phone}
â€¢ Photo before pay link: ${order.photoBeforePay ? "yes" : "no"}
â€¢ Notes: ${order.notes || "none"}

Price
â€¢ Base: ${money(t.base)}
â€¢ Item upsells: ${money(t.itemUpsells)}
â€¢ Order upsells: ${money(t.orderUpsells)}
â€¢ Coupon: -${money(t.coup)}
â€¢ Shipping: ${money(t.ship)}
â€¢ Donation: ${money(t.donation)}
â€¢ TOTAL: ${money(t.total)}`
  );
}

/* ========= SUBMIT (ONLY AFTER CONFIRM) ========= */
async function submitOrder(){
  const totals = calcTotals();

  for(const it of items){
    const need = needColorsCount(it);
    if(!it.itemType || !it.weave || !it.inches || !it.fit || it.colors.length!==need){
      throw new Error("Missing item info. Keep answering the questions.");
    }
    if(it.inches < MIN_IN || it.inches > MAX_IN){
      throw new Error(`Size must be between ${MIN_IN} and ${MAX_IN} inches.`);
    }
  }
  if(!order.shipping || !order.address || !order.name || !order.phone){
    throw new Error("Missing shipping/contact info.");
  }

  const payload = {
    status: "new",
    createdAt: serverTimestamp(),
    order: { ...order },
    items: items.map(x=>({ ...x })),
    totals
  };

  const ref = await addDoc(collection(db, ORDERS_COLLECTION), payload);
  return ref.id;
}

/* ========= COMMANDS ========= */
function handleCommand(text){
  const t = clean(text).trim();

  if(t==="restart"){ resetAll(); return true; }

  if(t==="back"){
    if(mode!=="order"){ addMsg("BACK only works while building the order.", "bot"); return true; }
    if(backStack.length===0){ addMsg("Already at the first question.", "bot"); askStep(); return true; }
    stepIndex = backStack.pop();
    addMsg("Okay â€” going back one step.", "bot");
    askStep();
    return true;
  }

  if(t==="confirm"){
    if(mode!=="review"){
      addMsg("Weâ€™re not at the end yet â€” keep answering the questions.", "bot");
      return true;
    }
    (async ()=>{
      try{
        setStatus("Submittingâ€¦");
        const id = await submitOrder();
        setStatus("Submitted!");
        mode = "done";
        addMsg(`âœ… Submitted!\nOrder ID: ${id}\nNext step: Iâ€™ll send your pay link.`, "bot");
        setChips(["RESTART"]);
      }catch(e){
        setStatus("");
        addMsg("âŒ Could not submit: " + (e?.message || e), "bot");
        mode = "order";
        askStep();
      }
    })();
    return true;
  }

  return false;
}

/* ========= MULTI QUOTE HANDLER ========= */
function applyMultiQuote(multi){
  items = multi.items;

  if(multi.orderHints){
    if(multi.orderHints.rush) order.rush = true;
    if(typeof multi.orderHints.donation === "number" && isFinite(multi.orderHints.donation)){
      order.donation = multi.orderHints.donation;
    }
  }

  const t = calcTotals();

  const breakdown = items.map((it,i)=>{
    const line = itemBase(it) + itemUpsells(it);
    const extras = [];
    if(it.durability) extras.push("durability");
    if(it.reflective) extras.push("reflective");
    if(it.glow) extras.push("glow");
    if(it.charm) extras.push("charm");
    if(it.extraTail) extras.push("extra tail");
    return `#${i+1}: ${it.weave} â€¢ ${it.inches}" â€¢ ${it.colors.join("/")} = ${money(line)}${extras.length ? ` (+ ${extras.join(", ")})` : ""}`;
  }).join("\n");

  addMsg(
`Hereâ€™s your estimate:
${breakdown}

Subtotal: ${money(t.subtotal)}
Shipping not included yet.

Want to place the order? If yes, tell me:
â€¢ in-state or out-of-state
â€¢ shipping address
â€¢ your name + phone`,
"bot");

  setChips(["in-state","out-of-state","RESTART"]);
  mode = "order";
  stepIndex = 0;
  backStack.length = 0;
  askStep();
}

/* ========= MAIN SEND ========= */
function send(){
  const text = input.value.trim();
  if(!text) return;
  input.value = "";
  addMsg(text, "user");
  setChips([]);
  setStatus("");

  if(handleCommand(text)) return;

  // âœ… NEW: FAQ works in ANY MODE without breaking the order flow
  const faq = answerFAQ(text);
  if(faq){
    addMsg(faq, "bot");

    if(mode === "order"){
      const cur = steps[stepIndex];
      if(cur){
        addMsg("Now back to your order:", "bot");
        addMsg(cur.ask, "bot");
        setChips(cur.chips || []);
        addMsg(pricePreviewLine(), "bot");
      }
    }else{
      setChips(["Price","Sizing","Colors","Shipping","Your story","Contact","I want one"]);
    }
    return;
  }

  // multi-bracelet sentence that asks price
  if(mode==="sales"){
    const multi = parseMultiBraceletMessage(text);
    if(multi && multi.items?.length){
      applyMultiQuote(multi);
      return;
    }

    if(wantsToBuy(text)){
      const h = extractHints(text);
      applyHintsToItem(h, items[0]);

      const don = parseDonation(text);
      if(typeof don === "number" && isFinite(don)) order.donation = don;

      addMsg(`${LIMITED_SPOTS}\n\nGot it â€” Iâ€™ll ask only whatâ€™s missing.`, "bot");
      mode = "order";
      stepIndex = 0;
      backStack.length = 0;
      askStep();
      return;
    }

    // fallback sales message
    addMsg(
`Ask me anything about price, sizing, colors, shipping, or custom orders.
Or tell me what you want and Iâ€™ll quote it.

${POPULAR_PICK}`,
      "bot"
    );
    setChips(["Price","Sizing","Colors","Shipping","Your story","Contact","I want one"]);
    logUnanswered(text);
    return;
  }

  if(mode==="order"){
    const h = extractHints(text);
    applyHintsToItem(h, items[0]);
    const don = parseDonation(text);
    if(typeof don === "number" && isFinite(don)) order.donation = don;

    const s = steps[stepIndex] || null;
    if(!s){ askStep(); return; }

    stepIndex = nextMissing(stepIndex);
    if(stepIndex >= steps.length){ askStep(); return; }

    const cur = steps[stepIndex];

    const parsed = cur.parse(text);
    if(parsed == null){
      const advanced = nextMissing(stepIndex);
      if(advanced !== stepIndex){
        addMsg("Got it.", "bot");
        stepIndex = advanced;
        askStep();
        return;
      }

      addMsg("I didnâ€™t catch that â€” try again.", "bot");
      addMsg(cur.ask, "bot");
      setChips(cur.chips || []);
      addMsg(pricePreviewLine(), "bot");
      logUnanswered(text);
      return;
    }

    backStack.push(stepIndex);
    cur.apply(parsed);

    if(cur.key==="couponAsk") skipCoupon = (parsed===false);
    if(cur.key==="donateAsk") skipDonation = (parsed===false);

    stepIndex++;
    askStep();
    return;
  }

  if(mode==="review"){
    addMsg("Type CONFIRM to submit, or BACK / RESTART.", "bot");
    setChips(["CONFIRM","BACK","RESTART"]);
    return;
  }

  addMsg("Type RESTART to start again.", "bot");
  setChips(["RESTART"]);
}

/* ========= RESET ========= */
function resetAll(){
  mode = "sales";
  stepIndex = 0;
  backStack.length = 0;
  skipCoupon = false;
  skipDonation = false;

  items = [makeItem()];
  Object.assign(order, {
    rush:false,
    giftNote:false,
    giftNoteText:"",
    donation:0,
    coupon:"",
    shipping:"",
    address:"",
    name:"",
    phone:"",
    photoBeforePay:false,
    notes:""
  });

  chat.innerHTML = "";
  setStatus("");

  addMsg(
`Hi! Welcome to Tactics & Treats.
Pricing: $${PRICE_PER_INCH}/inch (sizes ${MIN_IN}-${MAX_IN})
Shipping: $${SHIPPING_IN} in-state / $${SHIPPING_OUT} out-of-state

${POPULAR_PICK}
${LIMITED_SPOTS}

Do you have any questions before ordering?`,
  "bot");

  setChips(["Price","Sizing","Colors","Shipping","Your story","Contact","I want one"]);
}

document.getElementById("sendBtn").onclick = send;
document.getElementById("resetBtn").onclick = resetAll;
input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") send(); });

// load Firestore FAQ (optional) then start
await loadFAQ();
resetAll();
</script>

</body>
</html>
