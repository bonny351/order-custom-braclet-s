<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tactics & Treats â€“ Admin Panel</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  body{
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-weight:500;
    background:#111;
    color:#fff;
    margin:0;
    padding:20px;
  }

  h1,h2{
    text-align:center;
    color:#ff0000;
    margin:0;
    font-weight:700;
    letter-spacing:.2px;
  }

  header{
    display:flex;
    justify-content:center;
    background:linear-gradient(90deg,#7a0c0c,#000);
    padding:15px;
    border-radius:10px;
    box-shadow:0 0 12px rgba(255,0,0,0.4);
    margin-bottom:15px;
  }

  .tabs{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-bottom:15px;
    flex-wrap:wrap;
  }

  .tab{
    padding:10px 20px;
    cursor:pointer;
    border-radius:6px;
    background:#222;
    font-weight:700;
    user-select:none;
  }
  .tab.active{
    background:#ff0000;
    box-shadow:0 0 8px #ff0000;
  }

  .dashboard{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:12px;
    margin-bottom:15px;
  }
  .stat{
    background:#181818;
    padding:12px;
    border-radius:10px;
    box-shadow:0 0 10px rgba(255,0,0,.25);
    text-align:center;
  }
  .stat h3{ margin:0; color:#ffb347; font-weight:700; }
  .stat p{ font-size:20px; margin:5px 0 0; font-weight:700; }

  section{
    background:#181818;
    padding:20px;
    border-radius:12px;
    box-shadow:0 0 12px rgba(255,0,0,0.2);
  }

  .toolbar{
    display:flex;
    gap:10px;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    margin-top:12px;
  }
  .toolbar input{
    flex:1;
    min-width:220px;
    background:#111;
    color:#fff;
    border:1px solid #ff0000;
    border-radius:10px;
    padding:10px 12px;
    outline:none;
    font-weight:500;
  }
  .toolbar button{
    background:#ff0000;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:10px 14px;
    font-weight:800;
    cursor:pointer;
  }
  .toolbar button:hover{ background:darkred; }

  .tableWrap{
    width:100%;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    margin-top:12px;
    border-radius:10px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    table-layout:auto;
    min-width:1250px;
  }

  th,td{
    border:1px solid #ff0000;
    padding:10px 8px;
    text-align:center;
    white-space:nowrap;
    vertical-align:top;
  }

  th{
    background:#111;
    position:sticky;
    top:0;
    z-index:2;
    font-weight:800;
    letter-spacing:.2px;
  }

  tr:nth-child(even){ background:#222; }

  .statusSelect{
    background:#222;
    color:white;
    border:1px solid #ff0000;
    border-radius:8px;
    padding:7px;
    font-weight:700;
  }

  .newRow{ background:rgba(255,255,0,0.25)!important; }
  .doneRow{ background:rgba(0,255,0,0.25)!important; }
  .unpaidRow{ background:rgba(255,0,0,0.25)!important; }
  .pendingRow{ background:rgba(0,170,255,0.22)!important; }

  .deleteBtn{
    background:#ff2222;
    color:white;
    border:none;
    border-radius:8px;
    padding:6px 10px;
    font-weight:800;
    cursor:pointer;
  }
  .deleteBtn:hover{
    background:#aa0000;
    box-shadow:0 0 8px rgba(255,0,0,.6);
  }

  .note{
    text-align:center;
    font-size:12px;
    opacity:.85;
    margin-top:10px;
  }

  .wrapCell{
    white-space:normal;
    max-width:560px;
    line-height:1.2;
  }
</style>
</head>

<body>
<header><h1>Tactics & Treats Admin Panel</h1></header>

<div class="tabs">
  <div class="tab active" data-col="tt_orders">Chat Orders</div>
  <div class="tab" data-col="braceletOrders">Bracelet Orders</div>
  <div class="tab" data-col="cookieOrders">Cookie Orders</div>
  <div class="tab" data-col="spiritOrders">Spirit Wear</div>
  <div class="tab" data-col="products_bracelets">Bracelet Products</div>
  <div class="tab" data-col="products_cookies">Cookie Products</div>

  <!-- âœ… NEW: chatbot + admin training tabs -->
  <div class="tab" data-col="tt_faq">Chatbot FAQ</div>
  <div class="tab" data-col="tt_unanswered">Unanswered Qs</div>

  <div class="tab" data-col="auditLog">Audit Log</div>
</div>

<div class="dashboard" id="dashboard">
  <div class="stat"><h3>Today</h3><p id="todayCount">0</p></div>
  <div class="stat"><h3>This Week</h3><p id="weekCount">0</p></div>
  <div class="stat"><h3>Revenue</h3><p id="revenue">$0</p></div>
</div>

<section>
  <h2 id="tableTitle">Chat Orders</h2>

  <div class="toolbar">
    <input id="searchBox" placeholder="Search (name, phone, address, item, etc.)" />
    <button id="addBtn" style="display:none;">âž• Add FAQ</button>
    <button id="refreshBtn">Refresh</button>
  </div>

  <div class="tableWrap">
    <table id="table"></table>
  </div>

  <div class="note" id="note">
    Swipe left/right on the table. Chat Orders: status + delete only.
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    collection, doc, setDoc, addDoc, deleteDoc, updateDoc,
    onSnapshot, query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
    authDomain:"bracelets-and-color.firebaseapp.com",
    projectId:"bracelets-and-color",
    storageBucket:"bracelets-and-color.appspot.com",
    messagingSenderId:"382292570673",
    appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const table = document.getElementById("table");
  const tableTitle = document.getElementById("tableTitle");
  const todayCountEl = document.getElementById("todayCount");
  const weekCountEl = document.getElementById("weekCount");
  const revenueEl = document.getElementById("revenue");
  const dashboardEl = document.getElementById("dashboard");
  const searchBox = document.getElementById("searchBox");
  const refreshBtn = document.getElementById("refreshBtn");
  const addBtn = document.getElementById("addBtn");
  const noteEl = document.getElementById("note");

  let currentCollection = "tt_orders";
  let unsub = null;
  let lastRows = [];

  const COLLECTION_CONFIG = {
    tt_orders: {
      title: "Chat Orders",
      showDashboard: true,
      note: "Swipe left/right on the table. Chat Orders: status + delete only.",
      statusValues: ["new","pending","done","unpaid"],
      editable: [],
      columns: ["status","createdAt","name","phone","items","total","donation","coupon","shipping","address","photoBeforePay","id","delete"]
    },
    braceletOrders: {
      title: "Bracelet Orders",
      showDashboard: true,
      note: "Bracelet Orders: click cells to edit. Status dropdown updates instantly.",
      statusValues: ["new","pending","done","unpaid"],
      editable: ["name","phone","type","size","color1","color2","qty","price","total","status"],
      columns: ["status","createdAt","name","phone","type","size","color1","color2","qty","price","total","id","delete"]
    },
    cookieOrders: {
      title: "Cookie Orders",
      showDashboard: true,
      note: "Cookie Orders: click cells to edit.",
      statusValues: ["new","pending","done","unpaid","Pending","Completed"],
      editable: ["name","phone","email","product","type","qty","total","status"],
      columns: ["status","createdAt","name","phone","email","product","type","qty","total","id","delete"]
    },
    spiritOrders: {
      title: "Spirit Wear",
      showDashboard: true,
      note: "Spirit Wear: click cells to edit.",
      statusValues: ["new","pending","done","unpaid"],
      editable: ["name","phone","email","item","size","qty","price","total","status"],
      columns: ["status","createdAt","name","phone","email","item","size","qty","price","total","id","delete"]
    },
    products_bracelets: {
      title: "Bracelet Products",
      showDashboard: false,
      note: "Products: edit fields directly.",
      editable: ["type","sizeOptions","colorOptions","price"],
      columns: ["type","sizeOptions","colorOptions","price","id","delete"]
    },
    products_cookies: {
      title: "Cookie Products",
      showDashboard: false,
      note: "Products: edit fields directly.",
      editable: ["name","price","stock"],
      columns: ["name","price","stock","id","delete"]
    },

    /* âœ… NEW: Chatbot FAQ (shared with chatbot) */
    tt_faq: {
      title: "Chatbot FAQ",
      showDashboard: false,
      note: "Edit triggers as comma-separated words. The chatbot matches if the question includes any trigger.",
      editable: ["triggers","answer"],
      columns: ["createdAt","triggers","answer","id","delete"]
    },

    /* âœ… NEW: Unanswered questions (logged by chatbot) */
    tt_unanswered: {
      title: "Unanswered Qs",
      showDashboard: false,
      note: "These are questions the chatbot couldnâ€™t answer. Add an FAQ for common ones, then delete the row.",
      editable: [],
      columns: ["createdAt","text","id","delete"]
    },

    auditLog: {
      title: "Audit Log",
      showDashboard: false,
      note: "Audit trail of edits/deletes.",
      editable: [],
      columns: ["at","type","collection","id","field","from","to"]
    }
  };

  function safeDate(v){
    if(!v) return null;
    if(typeof v?.toDate === "function") return v.toDate();
    if(typeof v?.seconds === "number") return new Date(v.seconds * 1000);
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }
  function formatDate(v){
    const d = safeDate(v);
    return d ? d.toLocaleString() : "";
  }

  function normalizeStatus(s){
    if(!s) return "";
    const lower = String(s).toLowerCase();
    if(lower === "pending") return "pending";
    if(lower === "new") return "new";
    if(lower === "done" || lower === "completed") return "done";
    if(lower === "unpaid") return "unpaid";
    return String(s);
  }
  function colorRow(row,status){
    row.classList.remove("newRow","doneRow","unpaidRow","pendingRow");
    const s = normalizeStatus(status);
    if(s==="new") row.classList.add("newRow");
    if(s==="done") row.classList.add("doneRow");
    if(s==="unpaid") row.classList.add("unpaidRow");
    if(s==="pending") row.classList.add("pendingRow");
  }

  /* âœ… no raw JSON */
  function stringifyCell(val){
    if(val === null || val === undefined) return "";
    if(Array.isArray(val)) return val.join(", ");
    if(typeof val === "object"){
      // show timestamp-ish values nicely
      const d = safeDate(val);
      if(d) return d.toLocaleString();
      return "";
    }
    return String(val);
  }

  function applySearch(rows){
    const q = searchBox.value.trim().toLowerCase();
    if(!q) return rows;
    return rows.filter(r=>{
      const blob = Object.values(r).map(v=>stringifyCell(v).toLowerCase()).join(" | ");
      return blob.includes(q);
    });
  }

  // âœ… flatten chat orders
  function summarizeItems(items){
    if(!Array.isArray(items) || !items.length) return "";
    return items.map((it, idx)=>{
      const colors = Array.isArray(it.colors) ? it.colors.join("/") : "";
      const tag = it.engravedTagText ? ` tag:"${it.engravedTagText}"` : "";
      return `${idx+1}) ${it.itemType || ""} â€¢ ${it.weave || ""} â€¢ ${it.inches || ""}" â€¢ ${it.fit || ""} â€¢ ${colors}${tag}`.trim();
    }).join("  ||  ");
  }

  function flattenChatOrder(docRow){
    const o = docRow.order || {};
    const totals = docRow.totals || {};
    const items = docRow.items || [];

    return {
      id: docRow.id,
      status: docRow.status || "new",
      createdAt: docRow.createdAt || null,
      name: o.name || "",
      phone: o.phone || "",
      items: summarizeItems(items),
      total: totals.total ?? "",
      donation: (typeof o.donation === "number" ? o.donation : (totals.donation ?? 0)),
      coupon: o.coupon || "",
      shipping: o.shipping || "",
      address: o.address || "",
      photoBeforePay: o.photoBeforePay ? "yes" : "no"
    };
  }

  function getRowAmount(r){
    const total = parseFloat(r.total);
    if(!isNaN(total)) return total;
    const price = parseFloat(r.price);
    const qty = parseFloat(r.qty);
    if(!isNaN(price) && !isNaN(qty)) return price * qty;
    return 0;
  }

  function updateDashboard(rows){
    let today=0, week=0, revenue=0;
    const now = new Date();

    rows.forEach(r=>{
      const d = safeDate(r.createdAt);
      if(d){
        const diffDays = (now - d) / 86400000;
        if(diffDays < 1) today++;
        if(diffDays < 7) week++;
      }

      const status = normalizeStatus(r.status);
      const amount = getRowAmount(r);

      if(status === "done") revenue += amount;
      else if(status === "unpaid") revenue -= amount;
    });

    todayCountEl.textContent = today;
    weekCountEl.textContent = week;
    revenueEl.textContent = "$" + revenue.toFixed(2);
  }

  function getColumns(){
    const cfg = COLLECTION_CONFIG[currentCollection];
    return cfg?.columns?.length ? cfg.columns : ["id"];
  }
  function isEditable(col){
    const cfg = COLLECTION_CONFIG[currentCollection] || {};
    return (cfg.editable || []).includes(col);
  }
  function setTitleAndDashboard(){
    const cfg = COLLECTION_CONFIG[currentCollection] || {};
    tableTitle.textContent = cfg.title || currentCollection;
    dashboardEl.style.display = cfg.showDashboard ? "grid" : "none";
    noteEl.textContent = cfg.note || "";
    addBtn.style.display = (currentCollection === "tt_faq") ? "inline-block" : "none";
  }

  async function logAudit(payload){
    try{
      await addDoc(collection(db, "auditLog"), { ...payload, at: new Date() });
    }catch(e){
      console.warn("Audit log failed:", e?.message || e);
    }
  }

  function buildTable(rows){
    table.innerHTML = "";
    if(!rows.length){
      table.innerHTML = "<tr><td style='padding:14px;'>No Data</td></tr>";
      return;
    }

    const cols = getColumns();
    const header = table.insertRow();
    cols.forEach(c=>{
      const th = document.createElement("th");
      th.textContent = c;
      header.appendChild(th);
    });

    rows.forEach(r=>{
      const row = table.insertRow();

      cols.forEach(col=>{
        const cell = row.insertCell();

        /* âœ… delete works everywhere */
        if(col === "delete"){
          const btn = document.createElement("button");
          btn.textContent = "ðŸ—‘ Delete";
          btn.className = "deleteBtn";
          btn.onclick = async () => {
            if(!confirm("Delete this item forever?")) return;
            await deleteDoc(doc(db, currentCollection, r.id));
            await logAudit({ type:"delete", collection: currentCollection, id:r.id });
          };
          cell.appendChild(btn);
          return;
        }

        if(col === "status"){
          const cfg = COLLECTION_CONFIG[currentCollection] || {};
          const allowed = cfg.statusValues || ["new","pending","done","unpaid"];
          const sel = document.createElement("select");
          sel.className = "statusSelect";

          const current = r.status ?? "";
          const normalized = normalizeStatus(current);
          const options = [...new Set([normalized, ...allowed.map(normalizeStatus)])].filter(Boolean);

          options.forEach(v=>{
            const o = new Option(v, v);
            if(normalizeStatus(current) === v) o.selected = true;
            sel.add(o);
          });

          sel.onchange = async () => {
            const old = r.status ?? null;
            r.status = sel.value;

            if(currentCollection === "tt_orders"){
              await updateDoc(doc(db, currentCollection, r.id), { status: r.status });
            }else{
              await setDoc(doc(db, currentCollection, r.id), r);
            }

            await logAudit({ type:"status_change", collection: currentCollection, id: r.id, from: old, to: r.status });
            colorRow(row, r.status);
          };

          cell.appendChild(sel);
          return;
        }

        if(col === "createdAt" || col === "at"){
          cell.textContent = formatDate(r[col]);
          return;
        }

        if(col === "items" || col === "address" || col === "answer" || col === "text") cell.classList.add("wrapCell");

        // âœ… triggers display as comma list
        let displayVal = r[col];
        if(col === "triggers" && Array.isArray(displayVal)){
          displayVal = displayVal.join(", ");
        }

        cell.textContent = stringifyCell(displayVal ?? "");

        if(col !== "id" && isEditable(col)){
          cell.contentEditable = true;
          cell.onblur = async () => {
            const before = r[col];
            let newVal = cell.textContent.trim();

            // âœ… triggers stored as array for chatbot
            if(col === "triggers"){
              newVal = newVal
                .split(",")
                .map(x=>x.trim().toLowerCase())
                .filter(Boolean);
            }

            r[col] = newVal;

            // âœ… keep createdAt so itâ€™s readable/sortable
            if(!r.createdAt) r.createdAt = serverTimestamp();

            await setDoc(doc(db, currentCollection, r.id), r);
            await logAudit({ type:"edit", collection: currentCollection, id:r.id, field:col, from: before, to: r[col] });
          };
        } else {
          cell.contentEditable = false;
        }
      });

      colorRow(row, r.status);
    });
  }

  function subscribe(){
    if(unsub) unsub();

    setTitleAndDashboard();
    table.innerHTML = "<tr><td style='padding:14px;'>Loading...</td></tr>";

    const colRef = collection(db, currentCollection);

    // âœ… no orderBy for tt_orders (avoid index/rules issues)
    let qRef = colRef;
    if(currentCollection !== "tt_orders"){
      const wantsOrder = currentCollection.includes("Orders") || currentCollection === "auditLog" || currentCollection === "tt_unanswered" || currentCollection === "tt_faq";
      if(wantsOrder){
        const field = (currentCollection === "auditLog") ? "at" : "createdAt";
        qRef = query(colRef, orderBy(field, "desc"));
      }
    }

    unsub = onSnapshot(qRef, snap=>{
      let rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));

      if(currentCollection === "tt_orders"){
        rows = rows.map(flattenChatOrder);
      }

      lastRows = rows;

      const filtered = applySearch(lastRows);

      if(COLLECTION_CONFIG[currentCollection]?.showDashboard){
        updateDashboard(filtered);
      }

      buildTable(filtered);
    }, err=>{
      console.error(err);
      table.innerHTML = "<tr><td style='padding:14px;'>Error loading data. Check console for permissions/rules.</td></tr>";
    });
  }

  // âœ… add FAQ button
  addBtn.addEventListener("click", async ()=>{
    if(currentCollection !== "tt_faq") return;

    const triggersRaw = prompt('Triggers (comma-separated)\nExample: shipping, deliver, address');
    if(triggersRaw === null) return;

    const answer = prompt("Answer text the chatbot should reply with:");
    if(answer === null) return;

    const triggers = triggersRaw
      .split(",")
      .map(x=>x.trim().toLowerCase())
      .filter(Boolean);

    if(!triggers.length || !String(answer).trim()){
      alert("Need at least 1 trigger and an answer.");
      return;
    }

    const ref = await addDoc(collection(db, "tt_faq"), {
      triggers,
      answer: String(answer).trim(),
      createdAt: serverTimestamp()
    });

    await logAudit({ type:"create", collection:"tt_faq", id: ref.id });
  });

  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click", e=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      e.currentTarget.classList.add("active");
      currentCollection = e.currentTarget.dataset.col;
      subscribe();
    });
  });

  searchBox.addEventListener("input", ()=>{
    const filtered = applySearch(lastRows);
    if(COLLECTION_CONFIG[currentCollection]?.showDashboard) updateDashboard(filtered);
    buildTable(filtered);
  });

  refreshBtn.addEventListener("click", subscribe);

  subscribe();
</script>

</body>
</html>
