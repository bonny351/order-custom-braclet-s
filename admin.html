<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tactics & Treats – Smart Admin Bot (Full Updated)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0b0b; --panel:#141414; --panel2:#0f0f0f;
    --text:#fff; --muted:#c9c9c9; --accent:#ff2a2a;
    --line:#2a2a2a; --radius:16px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0; padding:16px;
    background:var(--bg); color:var(--text);
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{ max-width:1040px; margin:0 auto; }
  header{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; flex-wrap:wrap; margin-bottom:12px;
  }
  h1{ margin:0; color:var(--accent); font-size:20px; }
  .pill{
    font-size:12px; padding:6px 10px; border-radius:999px;
    background:#1f1f1f; border:1px solid #2a2a2a; color:var(--muted);
  }
  .card{
    background:var(--panel);
    border:1px solid #262626;
    border-radius:var(--radius);
    padding:14px;
    box-shadow:0 0 18px rgba(255,0,0,.16);
  }
  .chat{
    height:62vh; min-height:380px; max-height:720px;
    overflow:auto;
    padding:12px;
    border-radius:14px;
    background:#000;
    border:1px solid var(--line);
  }
  .msg{
    max-width:94%;
    padding:10px 12px;
    border-radius:14px;
    margin:10px 0;
    white-space:pre-line;
    line-height:1.35;
    word-break:break-word;
  }
  .bot{
    background:#101010;
    border:1px solid #2a2a2a;
    border-top-left-radius:6px;
  }
  .user{
    background:#1c1c1c;
    border:1px solid #333;
    margin-left:auto;
    border-top-right-radius:6px;
  }
  .chips{
    display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
  }
  .chip{
    background:#191919;
    border:1px solid #2f2f2f;
    color:#fff;
    padding:8px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:13px;
    font-weight:800;
    user-select:none;
  }
  .chip:hover{ filter:brightness(1.08); }
  .bar{ display:flex; gap:10px; margin-top:10px; }
  input{
    flex:1;
    border:none; outline:none;
    border-radius:14px;
    padding:12px 12px;
    font-size:15px;
    color:#fff;
    background:var(--panel2);
    border:1px solid var(--line);
  }
  button{
    border:none;
    border-radius:14px;
    padding:12px 14px;
    font-weight:900;
    cursor:pointer;
    background:var(--accent);
    color:#fff;
  }
  button:hover{ filter:brightness(1.08); }
  .secondary{
    background:#242424;
    border:1px solid #343434;
    color:#fff;
  }
  #status{
    margin-top:10px;
    color:#ffb347;
    font-weight:800;
    min-height:18px;
    white-space:pre-line;
  }
  .meta{
    font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35;
  }
  .meta b{ color:#fff; }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <h1>Tactics & Treats – Admin Bot (Full Updated)</h1>
    <div class="pill">Natural chat • SHOWALL • Nicknames • Bulk • DBSCAN • SCANFIX</div>
  </header>

  <div class="card">
    <div id="chat" class="chat"></div>
    <div id="chips" class="chips"></div>
    <div id="status"></div>

    <div class="bar">
      <input id="input" placeholder="Talk to me… (try: NEXT, showall john rush, unpaid, bulk)" autocomplete="off" />
      <button id="sendBtn" type="button">Send</button>
      <button id="resetBtn" type="button" class="secondary">Reset</button>
    </div>

    <div class="meta">
      Quick: <b>HELP</b>, <b>NEXT</b>, <b>UNPAID</b>, <b>UNFINISHED</b>, <b>MONTHLY GROSS</b>,
      <b>SHOWALL</b>, <b>DBSCAN</b>, <b>SCANFIX</b>, <b>BULK</b>, <b>ALIASES</b>
    </div>
  </div>
</div>

<!-- Firebase compat (easy hosting) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

<script>
/* =========================
   FIREBASE (your project)
========================= */
firebase.initializeApp({
  apiKey:"AIzaSyCiZuaANb1lrgdn-aARGJ_TRhgzPPUug58",
  authDomain:"bracelets-and-color.firebaseapp.com",
  projectId:"bracelets-and-color",
  storageBucket:"bracelets-and-color.appspot.com",
  messagingSenderId:"382292570673",
  appId:"1:382292570673:web:1c966e2e7e8fc2efa31b10"
});
const db = firebase.firestore();
const ts = () => firebase.firestore.FieldValue.serverTimestamp();

/* =========================
   COLLECTIONS
========================= */
const ORDERS = "tt_orders";
const SKILLS = "tt_skills";
const ALIASES = "tt_order_aliases"; // nickname -> orderId
const PRODUCTS = {
  bracelets: "products_bracelets",
  cookies: "products_cookies",
};

const DB_COLLECTIONS = [
  { key:"orders", name: ORDERS, limit: 500 },
  { key:"skills", name: SKILLS, limit: 500 },
  { key:"aliases", name: ALIASES, limit: 500 },
  { key:"bracelets", name: PRODUCTS.bracelets, limit: 500 },
  { key:"cookies", name: PRODUCTS.cookies, limit: 500 },
];

/* =========================
   UI
========================= */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const chipsBox = document.getElementById("chips");
const statusEl = document.getElementById("status");

function setStatus(msg){ statusEl.textContent = msg || ""; }
function addMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = "msg " + (who === "user" ? "user" : "bot");
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function setChips(options){
  chipsBox.innerHTML = "";
  (options || []).forEach(opt=>{
    const b = document.createElement("div");
    b.className = "chip";
    b.textContent = opt;
    b.onclick = ()=>{ input.value = opt; send(); };
    chipsBox.appendChild(b);
  });
}
function clean(s){ return String(s||"").trim(); }
function lower(s){ return clean(s).toLowerCase(); }
function upper(s){ return clean(s).toUpperCase(); }
function digitsOnly(s){ return String(s||"").replace(/[^\d]/g,""); }
function money(v){
  const n = Number(v);
  return Number.isFinite(n) ? "$" + n.toFixed(2) : "$0.00";
}
function safeToDate(v){
  if(!v) return null;
  if(typeof v?.toDate === "function") return v.toDate();
  if(typeof v?.seconds === "number") return new Date(v.seconds*1000);
  const d = new Date(v);
  return isNaN(d.getTime()) ? null : d;
}
function fmtDate(v){
  const d = safeToDate(v);
  return d ? d.toLocaleString() : "";
}
function normalizeStatus(s){
  const t = String(s||"new").toLowerCase().trim();
  if(["new","pending","unpaid","done","archived","cancelled","refunded","flagged"].includes(t)) return t;
  if(t === "completed") return "done";
  return t || "new";
}
function startOfToday(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
function startOfWeek(){ const d=startOfToday(); const day=d.getDay(); d.setDate(d.getDate()-day); return d; }
function startOfMonth(){ const d=startOfToday(); d.setDate(1); return d; }
function orderCreatedDate(r){ return safeToDate(r.createdAt) || new Date(0); }
function isToday(r){ return orderCreatedDate(r) >= startOfToday(); }
function isThisWeek(r){ return orderCreatedDate(r) >= startOfWeek(); }
function isThisMonth(r){ return orderCreatedDate(r) >= startOfMonth(); }

function orderTotal(r){
  const n = Number(r?.totals?.total);
  return Number.isFinite(n) ? n : 0;
}

/* =========================
   DISPLAY: EVERYTHING ABOUT ITEMS + ORDER
========================= */
function summarizeItems(items){
  if(!Array.isArray(items) || !items.length) return "(none)";

  const pickExtras = (it)=>{
    const extras = [];
    for(const [k,v] of Object.entries(it || {})){
      if(v === undefined || v === null) continue;
      if(v === "" ) continue;
      if(Array.isArray(v) && v.length === 0) continue;
      if(typeof v === "boolean" && v === false) continue;

      // skip fields we already print nicely below
      if(["itemType","weave","inches","fit","colors","patternStyle"].includes(k)) continue;

      extras.push(`${k}: ${Array.isArray(v) ? v.join(", ") : String(v)}`);
    }
    return extras;
  };

  return items.map((it, i)=>{
    const colors = Array.isArray(it.colors) ? it.colors.join(" / ") : "";
    const extras = pickExtras(it);

    return [
      `${i+1}) ${it.itemType || "(item)"}`,
      `   • weave: ${it.weave || ""}`,
      `   • size: ${it.inches || ""}"`,
      `   • fit: ${it.fit || ""}`,
      `   • colors: ${colors || "(none)"}`,
      `   • pattern: ${it.patternStyle || "(none)"}`,
      extras.length ? `   • extras:\n     - ${extras.join("\n     - ")}` : `   • extras: (none)`
    ].join("\n");
  }).join("\n\n");
}

function orderCard(id, data){
  const o = data?.order || {};
  const status = normalizeStatus(data?.status);

  const totals = data?.totals || {};
  const totalNum = Number(totals.total);
  const totalTxt = Number.isFinite(totalNum) ? money(totalNum) : (totals.total ?? "");

  // Known top-level fields (everything else gets printed under EXTRA FIELDS)
  const knownTop = new Set([
    "status","createdAt","order","items","totals",
    "assignedTo","adminNote","tracking","flagged","problemNote",
    "paidAt","shippedAt","doneAt",
    "notes","giftNote","giftNoteText","trackingUpgrade","packaging","photoBeforePay",
    "donation","coupon"
  ]);

  // Print any unknown top fields too
  const extraTop = [];
  for(const [k,v] of Object.entries(data || {})){
    if(knownTop.has(k)) continue;
    if(v === undefined || v === null) continue;
    if(v === "" ) continue;
    if(Array.isArray(v) && v.length === 0) continue;
    if(typeof v === "boolean" && v === false) continue;

    if(typeof v?.toDate === "function") extraTop.push(`${k}: ${fmtDate(v)}`);
    else extraTop.push(`${k}: ${Array.isArray(v) ? JSON.stringify(v) : String(v)}`);
  }

  const totalsLines = [];
  for(const [k,v] of Object.entries(totals || {})){
    if(v === undefined || v === null) continue;
    if(typeof v === "number") totalsLines.push(`  • ${k}: ${money(v)}`);
    else totalsLines.push(`  • ${k}: ${String(v)}`);
  }

  const orderLines = [];
  for(const [k,v] of Object.entries(o || {})){
    if(v === undefined || v === null) continue;
    if(v === "" ) continue;
    if(typeof v === "boolean" && v === false) continue;
    orderLines.push(`  • ${k}: ${String(v)}`);
  }

  return [
    `ORDER FULL DETAILS`,
    `Order ID: ${id}`,
    `Status: ${status}`,
    `Created: ${fmtDate(data?.createdAt)}`,
    ``,
    `Customer / Shipping (order object):`,
    orderLines.length ? orderLines.join("\n") : "  (none)",
    ``,
    `Admin fields:`,
    `  • assignedTo: ${data?.assignedTo || ""}`,
    `  • adminNote: ${data?.adminNote || ""}`,
    `  • tracking: ${data?.tracking || ""}`,
    `  • flagged: ${data?.flagged ? "yes" : "no"}`,
    `  • problemNote: ${data?.problemNote || ""}`,
    `  • paidAt: ${fmtDate(data?.paidAt)}`,
    `  • shippedAt: ${fmtDate(data?.shippedAt)}`,
    `  • doneAt: ${fmtDate(data?.doneAt)}`,
    ``,
    `Customer extras:`,
    `  • notes: ${data?.notes || ""}`,
    `  • giftNote: ${data?.giftNote ? "yes" : "no"}`,
    `  • giftNoteText: ${data?.giftNoteText || ""}`,
    `  • trackingUpgrade: ${data?.trackingUpgrade ? "yes" : "no"}`,
    `  • packaging: ${data?.packaging ? "yes" : "no"}`,
    `  • photoBeforePay: ${data?.photoBeforePay ? "yes" : "no"}`,
    `  • coupon: ${data?.coupon || ""}`,
    `  • donation: ${money(data?.donation || 0)}`,
    ``,
    `Totals:`,
    totalsLines.length ? totalsLines.join("\n") : "  (none)",
    `  • total_display: ${totalTxt}`,
    ``,
    `Items:`,
    summarizeItems(data?.items || []),
    ``,
    extraTop.length ? `EXTRA FIELDS:\n${extraTop.map(x=>"• "+x).join("\n")}` : "EXTRA FIELDS: (none)"
  ].join("\n");
}

function compactOrderLine(r){
  const o = r.order || {};
  const t = orderTotal(r);
  return `• ${r.id} | ${normalizeStatus(r.status)} | ${o.name||""} | ${o.phone||""} | ${money(t)}`;
}
function formatOrderList(rows, title){
  if(!rows.length) return `${title}: none found.`;
  return [
    `${title} (showing ${rows.length}):`,
    ...rows.map(compactOrderLine)
  ].join("\n");
}

/* =========================
   CACHES (fast)
========================= */
let orderCache = [];
let orderCacheAt = 0;

let skillsCache = [];
let skillsCacheAt = 0;

let aliasCache = [];
let aliasCacheAt = 0;

const TTL = 15000;
const ORDER_FETCH_LIMIT = 900;

async function refreshOrders(){
  const snap = await db.collection(ORDERS).limit(ORDER_FETCH_LIMIT).get();
  orderCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  orderCacheAt = Date.now();
  return orderCache;
}
async function ensureOrdersFresh(){
  if(!orderCache.length || (Date.now() - orderCacheAt) > TTL) await refreshOrders();
  return orderCache;
}

async function refreshSkills(){
  const snap = await db.collection(SKILLS).limit(900).get();
  skillsCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  skillsCacheAt = Date.now();
  return skillsCache;
}
async function ensureSkillsFresh(){
  if(!skillsCache.length || (Date.now() - skillsCacheAt) > TTL) await refreshSkills();
  return skillsCache;
}

async function refreshAliases(){
  const snap = await db.collection(ALIASES).limit(900).get();
  aliasCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  aliasCacheAt = Date.now();
  return aliasCache;
}
async function ensureAliasesFresh(){
  if(!aliasCache.length || (Date.now() - aliasCacheAt) > TTL) await refreshAliases();
  return aliasCache;
}

function bustOrders(){ orderCacheAt = 0; }
function bustSkills(){ skillsCacheAt = 0; }
function bustAliases(){ aliasCacheAt = 0; }

/* =========================
   ALIASES (nicknames)
========================= */
function normAlias(s){
  return String(s||"")
    .toLowerCase()
    .trim()
    .replace(/\s+/g," ")
    .replace(/[^\w\s-]/g,"");
}
function looksLikeId(tok){
  const t = String(tok||"").trim();
  if(!t) return false;
  if(t.length < 4) return false;
  if(t.includes(" ")) return false;
  return /[a-z0-9]/i.test(t);
}
async function setAlias(alias, orderId){
  const a = normAlias(alias);
  if(!a) throw new Error("Alias is empty.");
  if(!orderId) throw new Error("OrderId missing.");
  await db.collection(ALIASES).doc(a).set({
    alias: a,
    orderId: String(orderId).trim(),
    updatedAt: ts()
  }, { merge:true });
  bustAliases();
}
async function getAlias(alias){
  const a = normAlias(alias);
  const snap = await db.collection(ALIASES).doc(a).get();
  return snap.exists ? snap.data() : null;
}
async function deleteAlias(alias){
  const a = normAlias(alias);
  await db.collection(ALIASES).doc(a).delete();
  bustAliases();
}
async function listAliases(limit=80){
  const snap = await db.collection(ALIASES).limit(limit).get();
  return snap.docs.map(d=>d.data());
}
async function resolveOrderId(token){
  const t = String(token||"").trim();
  if(!t) return "";
  if(looksLikeId(t)) return t;
  const hit = await getAlias(t);
  return hit?.orderId || "";
}

/* =========================
   SKILLS (learn)
========================= */
async function saveSkill(trigger, action){
  await db.collection(SKILLS).add({
    trigger: normAlias(trigger),
    action: String(action||"").trim(),
    createdAt: ts()
  });
  bustSkills();
}
async function deleteSkillByTrigger(trigger){
  const trg = normAlias(trigger);
  const snap = await db.collection(SKILLS).where("trigger","==",trg).limit(80).get();
  const batch = db.batch();
  snap.docs.forEach(d=>batch.delete(d.ref));
  await batch.commit();
  bustSkills();
}

/* =========================
   DBSCAN (schema-ish)
========================= */
function typeOfValue(v){
  if(v === null) return "null";
  if(Array.isArray(v)) return "array";
  if(typeof v?.toDate === "function") return "timestamp";
  const t = typeof v;
  if(t === "object") return "object";
  return t;
}
function mergeType(map, key, t){
  if(!map[key]) map[key] = new Set();
  map[key].add(t);
}
function walkSchema(obj, prefix, map){
  if(!obj || typeof obj !== "object") return;
  for(const k of Object.keys(obj)){
    const path = prefix ? `${prefix}.${k}` : k;
    const v = obj[k];
    const t = typeOfValue(v);
    mergeType(map, path, t);
    if(t === "object") walkSchema(v, path, map);
  }
}
function schemaReport(docs){
  const map = {};
  for(const d of docs) walkSchema(d, "", map);
  const keys = Object.keys(map).sort();
  if(!keys.length) return "(no fields)";
  return keys.map(k=>`• ${k}: ${Array.from(map[k]).sort().join(" | ")}`).join("\n");
}
async function scanCollection(colName, lim){
  const snap = await db.collection(colName).limit(lim).get();
  return snap.docs.map(d=>({ id:d.id, ...d.data() }));
}
function summarizeOrders(docs){
  const statusCount = {};
  let doneRevenue = 0;
  for(const o of docs){
    const s = normalizeStatus(o.status);
    statusCount[s] = (statusCount[s]||0)+1;
    if(s==="done") doneRevenue += orderTotal(o);
  }
  const lines = Object.keys(statusCount).sort().map(k=>`• ${k}: ${statusCount[k]}`);
  return [
    `Orders scanned: ${docs.length}`,
    `Done revenue (scanned): ${money(doneRevenue)}`,
    `Status breakdown:\n${lines.join("\n") || "(none)"}`
  ].join("\n");
}
function summarizeAliases(docs){
  const sample = docs.slice(0, 12).map(a=>`• "${a.alias}" → ${a.orderId}`).join("\n") || "(none)";
  return `Aliases scanned: ${docs.length}\nSample:\n${sample}`;
}
function summarizeSkills(docs){
  const sample = docs.slice(0, 12).map(s=>`• "${s.trigger}" → ${s.action}`).join("\n") || "(none)";
  return `Skills scanned: ${docs.length}\nSample:\n${sample}`;
}
function summarizeProducts(docs){
  let low=0,out=0;
  for(const p of docs){
    const stock = Number(p.stock);
    if(Number.isFinite(stock)){
      if(stock<=0) out++;
      else if(stock<=3) low++;
    }
  }
  return `Products scanned: ${docs.length}\nOut of stock: ${out}\nLow stock (<=3): ${low}`;
}
async function dbScanAll(){
  const blocks = [];
  for(const c of DB_COLLECTIONS){
    const docs = await scanCollection(c.name, c.limit);
    let summary = "";
    if(c.name === ORDERS) summary = summarizeOrders(docs);
    else if(c.name === SKILLS) summary = summarizeSkills(docs);
    else if(c.name === ALIASES) summary = summarizeAliases(docs);
    else summary = summarizeProducts(docs);

    blocks.push(
      `=== ${c.name} ===\n` +
      summary + "\n\n" +
      `Schema (inferred):\n` +
      schemaReport(docs.slice(0, 80))
    );
  }
  return blocks.join("\n\n");
}

/* =========================
   SCANFIX (safe plan + confirm)
========================= */
const FIX_RULES = {
  ensureOrderStatus: true,
  ensureCreatedAt: true,
  ensurePhoneDigits: true,
  ensureTotalsNumber: true,
  normalizeSkillTrigger: true,
  ensureProductStockNumber: true
};
function isTimestamp(v){ return v && typeof v.toDate === "function"; }

async function scanCollectionWithRefs(col, lim){
  const snap = await db.collection(col).limit(lim).get();
  return snap.docs.map(d => ({ __id: d.id, __ref: d.ref, ...d.data() }));
}
function addFix(plan, ref, id, patch, reason){
  if(!patch || !Object.keys(patch).length) return;
  plan.fixes.push({ ref, id, patch, reason });
}
async function buildFixPlan(){
  const plan = { createdAt: new Date().toISOString(), fixes: [], summary: [] };

  // ORDERS fixes
  {
    const orders = await scanCollectionWithRefs(ORDERS, 500);
    let missingStatus=0, normedStatus=0, missingCreated=0, phoneFixed=0, totalsFixed=0;

    for(const o of orders){
      const patch = {};

      if(FIX_RULES.ensureOrderStatus){
        if(o.status == null){
          patch.status = "new"; missingStatus++;
        }else{
          const ns = normalizeStatus(o.status);
          if(ns !== o.status){ patch.status = ns; normedStatus++; }
        }
      }

      if(FIX_RULES.ensureCreatedAt){
        const ok = o.createdAt && (isTimestamp(o.createdA
