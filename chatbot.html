<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tactics & Treats â€“ Chat Order (Firebase)</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#141414;
    --panel2:#0f0f0f;
    --text:#fff;
    --muted:#bdbdbd;
    --accent:#ff2a2a;
    --good:#00ff88;
    --line:#2a2a2a;
    --radius:16px;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    padding:18px;
    background:var(--bg);
    color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{ max-width:820px; margin:0 auto; }
  header{
    display:flex; gap:12px; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
    margin-bottom:14px;
  }
  h1{ margin:0; color:var(--accent); font-size:22px; }
  .pill{
    font-size:12px; padding:6px 10px; border-radius:999px;
    background:#1f1f1f; color:var(--muted); border:1px solid #2a2a2a;
  }
  .card{
    background:var(--panel);
    border:1px solid #262626;
    border-radius:var(--radius);
    padding:14px;
    box-shadow: 0 0 18px rgba(255,0,0,.18);
  }
  .chat{
    height: 520px;
    overflow:auto;
    padding:12px;
    border-radius:14px;
    background:#000;
    border:1px solid var(--line);
  }
  .msg{
    max-width: 92%;
    padding:10px 12px;
    border-radius:14px;
    margin:10px 0;
    white-space:pre-line;
    line-height:1.35;
  }
  .bot{
    background:#101010;
    border:1px solid #2a2a2a;
    color:#fff;
    border-top-left-radius:6px;
  }
  .user{
    background:#1c1c1c;
    border:1px solid #333;
    margin-left:auto;
    border-top-right-radius:6px;
  }
  .meta{
    font-size:12px;
    color:var(--muted);
    margin-top:10px;
    line-height:1.35;
  }
  .bar{
    display:flex;
    gap:10px;
    margin-top:10px;
  }
  input{
    flex:1;
    border:none;
    outline:none;
    border-radius:14px;
    padding:12px 12px;
    font-size:15px;
    color:#fff;
    background:var(--panel2);
    border:1px solid var(--line);
  }
  button{
    border:none;
    border-radius:14px;
    padding:12px 14px;
    font-weight:800;
    cursor:pointer;
    background:var(--accent);
    color:#fff;
  }
  button:hover{ filter:brightness(1.08); }
  .secondary{
    background:#242424;
    border:1px solid #343434;
    color:#fff;
  }
  .good{
    background:var(--good);
    color:#000;
  }
  .chips{
    display:flex; flex-wrap:wrap; gap:8px;
    margin-top:10px;
  }
  .chip{
    background:#191919;
    border:1px solid #2f2f2f;
    color:#fff;
    padding:8px 10px;
    border-radius:999px;
    cursor:pointer;
    font-size:13px;
    font-weight:700;
  }
  .chip:hover{ filter:brightness(1.08); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Tactics & Treats â€“ Chat Order</h1>
    <div class="pill">Asks questions â†’ shows total â†’ CONFIRM â†’ submits to Firestore</div>
  </header>

  <div class="card">
    <div id="chat" class="chat"></div>

    <div class="chips" id="chips"></div>

    <div class="bar">
      <input id="input" placeholder="Type your answerâ€¦" autocomplete="off" />
      <button id="sendBtn">Send</button>
      <button class="secondary" id="resetBtn" title="Start over">Reset</button>
    </div>

    <div class="meta">
      Commands:
      â€¢ type <b>BACK</b> to go back one question
      â€¢ type <b>RESTART</b> to start over
      â€¢ at the end type <b>CONFIRM</b> to submit
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ðŸ”¥ YOUR FIREBASE CONFIG (paste yours here) */
const firebaseConfig = {
  apiKey: "PASTE_YOURS",
  authDomain: "PASTE_YOURS",
  projectId: "PASTE_YOURS",
  storageBucket: "PASTE_YOURS",
  messagingSenderId: "PASTE_YOURS",
  appId: "PASTE_YOURS"
};

const ORDERS_COLLECTION = "tt_orders"; // change if you want

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- Your Business Rules ---------- */
const PRICE_PER_INCH = 1;
const MIN_IN = 5;
const MAX_IN = 40;
const SHIPPING_IN = 6;
const SHIPPING_OUT = 10;

// default add-on charges (edit if you want)
const ADDON_FEE = 3;       // names/metal/glow
const SURVIVAL_FEE = 5;    // survival cord

const SIGNATURE = "Tactics & Treats Team";

/* ---------- Chat Engine ---------- */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const resetBtn = document.getElementById("resetBtn");
const chipsBox = document.getElementById("chips");

function addMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = "msg " + (who === "user" ? "user" : "bot");
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function setChips(options){
  chipsBox.innerHTML = "";
  (options || []).forEach(opt=>{
    const b = document.createElement("button");
    b.className = "chip";
    b.type = "button";
    b.textContent = opt;
    b.onclick = ()=>{ input.value = opt; send(); };
    chipsBox.appendChild(b);
  });
}

function money(n){
  const x = Number(n);
  if(!isFinite(x)) return "$0";
  return "$" + x.toFixed(2).replace(/\.00$/,"");
}

const order = {
  name: "",
  phone: "",
  address: "",
  itemType: "",
  weave: "",
  inches: 0,
  fit: "",
  colors: [],
  shipping: "", // "in" | "out"
  addOns: {
    names: false,
    metal: false,
    glow: false,
    survival: false
  },
  notes: ""
};

const steps = [
  {
    key: "itemType",
    ask: "What are you ordering?\nReply with: bracelet, dog collar, or keychain",
    chips: ["bracelet","dog collar","keychain"],
    parse: (v)=>{
      v = v.toLowerCase().trim();
      if(["bracelet","dog collar","keychain"].includes(v)) return v;
      return null;
    }
  },
  {
    key: "weave",
    ask: "Which weave do you want?\nReply with: cobra (2 colors) or king cobra (3 colors)",
    chips: ["cobra","king cobra"],
    parse: (v)=>{
      v = v.toLowerCase().trim();
      if(v === "cobra" || v === "king cobra") return v;
      return null;
    }
  },
  {
    key: "inches",
    ask: `What size in inches? (Between ${MIN_IN} and ${MAX_IN})\nExample: 8`,
    chips: ["6","7","8","9","10","12","14","16"],
    parse: (v)=>{
      const n = Number(String(v).replace(/"/g,"").trim());
      if(isFinite(n) && n >= MIN_IN && n <= MAX_IN) return n;
      return null;
    }
  },
  {
    key: "fit",
    ask: "How do you want it to fit?\nReply: snug, regular, or loose",
    chips: ["snug","regular","loose"],
    parse: (v)=>{
      v = v.toLowerCase().trim();
      if(["snug","regular","loose"].includes(v)) return v;
      return null;
    }
  },
  {
    key: "colors",
    ask: "Now the colors.\nFor cobra: send 2 colors (example: black, red)\nFor king cobra: send 3 colors (example: black, red, gray)",
    chips: ["black, red", "black, red, gray", "camo, black", "red, black"],
    parse: (v)=>{
      const parts = v.split(",").map(s=>s.trim()).filter(Boolean);
      const needed = (order.weave === "king cobra") ? 3 : 2;
      if(parts.length === needed) return parts;
      return null;
    }
  },
  {
    key: "addOns",
    ask: "Any add-ons?\nReply with: none, or list what you want: names, metal, glow, survival",
    chips: ["none","names","metal","glow","survival","names, metal","glow, survival"],
    parse: (v)=>{
      v = v.toLowerCase().trim();
      if(v === "none") return {names:false,metal:false,glow:false,survival:false};

      const picks = v.split(",").map(s=>s.trim()).filter(Boolean);
      const ok = new Set(["names","metal","glow","survival"]);
      if(picks.length === 0) return null;
      for(const p of picks){ if(!ok.has(p)) return null; }

      return {
        names: picks.includes("names"),
        metal: picks.includes("metal"),
        glow: picks.includes("glow"),
        survival: picks.includes("survival")
      };
    }
  },
  {
    key: "shipping",
    ask: "Shipping: are you in-state or out-of-state?\nReply: in-state or out-of-state",
    chips: ["in-state","out-of-state"],
    parse: (v)=>{
      v = v.toLowerCase().trim();
      if(v === "in-state") return "in";
      if(v === "out-of-state") return "out";
      return null;
    }
  },
  {
    key: "address",
    ask: "What shipping address should we ship to?\nType the full address (Street, City, State, ZIP).",
    chips: [],
    parse: (v)=>{
      v = v.trim();
      if(v.length >= 10) return v;
      return null;
    }
  },
  {
    key: "name",
    ask: "What name should I put on the order?",
    chips: [],
    parse: (v)=>{
      v = v.trim();
      if(v.length >= 2) return v;
      return null;
    }
  },
  {
    key: "phone",
    ask: "What phone number should I attach to the order?",
    chips: [],
    parse: (v)=>{
      const cleaned = v.replace(/[^\d]/g,"");
      if(cleaned.length >= 10) return v.trim();
      return null;
    }
  },
  {
    key: "notes",
    ask: "Any notes? (Reply: none, or type your note.)",
    chips: ["none"],
    parse: (v)=>{
      v = v.trim();
      if(v.toLowerCase() === "none") return "";
      if(v.length >= 0) return v;
      return null;
    }
  }
];

let stepIndex = 0;
const historySteps = []; // stack for BACK

function calcTotals(){
  const base = (Number(order.inches) || 0) * PRICE_PER_INCH;
  let addons = 0;
  if(order.addOns.names) addons += ADDON_FEE;
  if(order.addOns.metal) addons += ADDON_FEE;
  if(order.addOns.glow) addons += ADDON_FEE;
  if(order.addOns.survival) addons += SURVIVAL_FEE;

  const ship = order.shipping === "in" ? SHIPPING_IN : (order.shipping === "out" ? SHIPPING_OUT : 0);
  const total = base + addons + ship;

  return { base, addons, ship, total };
}

function summaryText(){
  const t = calcTotals();
  const addList = [];
  if(order.addOns.names) addList.push("names/letters");
  if(order.addOns.metal) addList.push("metal buckle/special clasp");
  if(order.addOns.glow) addList.push("glow/reflective");
  if(order.addOns.survival) addList.push("survival cord (includes flammable strands + fishing line)");

  return (
`Order Summary
â€¢ Item: ${order.itemType}
â€¢ Weave: ${order.weave}
â€¢ Size: ${order.inches}"
â€¢ Fit: ${order.fit}
â€¢ Colors: ${order.colors.join(", ")}
â€¢ Add-ons: ${addList.length ? addList.join(", ") : "none"}
â€¢ Shipping: ${order.shipping === "in" ? "in-state" : "out-of-state"}
â€¢ Address: ${order.address}
â€¢ Name: ${order.name}
â€¢ Phone: ${order.phone}
â€¢ Notes: ${order.notes ? order.notes : "none"}

Price
â€¢ Size: ${money(t.base)}
â€¢ Add-ons: ${money(t.addons)}
â€¢ Shipping: ${money(t.ship)}
â€¢ Total: ${money(t.total)}

If everything looks right, type: CONFIRM
If you need to change something, type: BACK (or RESTART).`
  );
}

function askCurrent(){
  const s = steps[stepIndex];
  addMsg(s.ask, "bot");
  setChips(s.chips || []);
}

function resetAll(){
  stepIndex = 0;
  historySteps.length = 0;

  order.name = "";
  order.phone = "";
  order.address = "";
  order.itemType = "";
  order.weave = "";
  order.inches = 0;
  order.fit = "";
  order.colors = [];
  order.shipping = "";
  order.addOns = {names:false,metal:false,glow:false,survival:false};
  order.notes = "";

  chat.innerHTML = "";
  addMsg("Hi! Iâ€™ll take your order step-by-step.\nPrices: $1 per inch (5â€“40). Shipping: $6 in-state, $10 out-of-state.\nLetâ€™s start.", "bot");
  askCurrent();
}

async function submitOrder(){
  const t = calcTotals();
  const addList = [];
  if(order.addOns.names) addList.push("names/letters");
  if(order.addOns.metal) addList.push("metal buckle/special clasp");
  if(order.addOns.glow) addList.push("glow/reflective");
  if(order.addOns.survival) addList.push("survival cord");

  const doc = {
    name: order.name,
    phone: order.phone,
    address: order.address,
    itemType: order.itemType,
    weave: order.weave,
    inches: order.inches,
    fit: order.fit,
    colors: order.colors,
    addOns: addList,
    notes: order.notes || "",
    pricing: {
      pricePerInch: PRICE_PER_INCH,
      base: t.base,
      addOnsTotal: t.addons,
      shipping: t.ship,
      total: t.total
    },
    status: "new",
    createdAt: serverTimestamp()
  };

  const ref = await addDoc(collection(db, ORDERS_COLLECTION), doc);
  return ref.id;
}

function handleCommand(cmd){
  const c = cmd.toLowerCase().trim();
  if(c === "restart"){
    resetAll();
    return true;
  }
  if(c === "back"){
    if(historySteps.length === 0){
      addMsg("Youâ€™re already at the first question.", "bot");
      return true;
    }
    stepIndex = historySteps.pop();
    addMsg("Okay â€” going back one step.", "bot");
    askCurrent();
    return true;
  }
  return false;
}

async function handleConfirm(){
  try{
    addMsg("Submitting your order to the systemâ€¦", "bot");
    const id = await submitOrder();
    addMsg(`âœ… Order submitted!\nOrder ID: ${id}\n\nWeâ€™ll send your payment link next.\n\n${SIGNATURE}`, "bot");
    setChips(["RESTART"]);
  }catch(e){
    console.error(e);
    addMsg("âŒ Order submit failed.\nThis usually means the Firebase config or Firestore rules need fixing.", "bot");
    setChips(["RESTART"]);
  }
}

function applyParsed(stepKey, parsed){
  if(stepKey === "itemType") order.itemType = parsed;
  if(stepKey === "weave") order.weave = parsed;
  if(stepKey === "inches") order.inches = parsed;
  if(stepKey === "fit") order.fit = parsed;
  if(stepKey === "colors") order.colors = parsed;
  if(stepKey === "addOns") order.addOns = parsed;
  if(stepKey === "shipping") order.shipping = parsed;
  if(stepKey === "address") order.address = parsed;
  if(stepKey === "name") order.name = parsed;
  if(stepKey === "phone") order.phone = parsed;
  if(stepKey === "notes") order.notes = parsed;
}

async function send(){
  const text = input.value.trim();
  if(!text) return;
  input.value = "";
  addMsg(text, "user");
  setChips([]);

  // Commands
  if(handleCommand(text)) return;

  // End confirm
  if(stepIndex >= steps.length){
    if(text.trim().toLowerCase() === "confirm"){
      await handleConfirm();
      return;
    }
    addMsg('Type CONFIRM to submit, or BACK / RESTART to change something.', "bot");
    setChips(["CONFIRM","BACK","RESTART"]);
    return;
  }

  const s = steps[stepIndex];
  const parsed = s.parse(text);

  if(parsed == null){
    addMsg("I didnâ€™t catch that. Please answer in the format I asked.", "bot");
    askCurrent();
    return;
  }

  // Save history for BACK
  historySteps.push(stepIndex);

  // Apply
  applyParsed(s.key, parsed);

  // Special: if weave is cobra, ignore color3 expectation (already handled in parse)
  // Move next
  stepIndex++;

  // If finished -> show summary
  if(stepIndex >= steps.length){
    addMsg(summaryText(), "bot");
    setChips(["CONFIRM","BACK","RESTART"]);
    return;
  }

  // Continue
  askCurrent();
}

sendBtn.onclick = send;
resetBtn.onclick = resetAll;
input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") send();
});

/* Start */
resetAll();
</script>
</body>
</html>
